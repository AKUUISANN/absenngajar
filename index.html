<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi & Nilai Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .grade-input::-webkit-outer-spin-button,
        .grade-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .grade-input[type=number] {
            -moz-appearance: textfield;
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: white;
        }
        
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background: white;
        }
        
        .sticky-col-2 {
            position: sticky;
            left: 50px;
            z-index: 10;
            background: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- Navigation Menu Button -->
                    <button id="navMenuBtn" onclick="toggleNav()" 
                            class="hidden bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg shadow-md transition-all duration-200 hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Sistem Absensi & Nilai Siswa</h1>
                        <p class="text-gray-600 text-sm">SMK CIJANGKAR</p>
                    </div>
                </div>
                <div id="userInfo" class="hidden flex items-center gap-3">
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-800" id="currentUser">-</p>
                        <p class="text-xs text-gray-500" id="loginTime">-</p>
                    </div>
                    <!-- Profile Photo -->
                    <div class="relative">
                        <button id="profilePhotoBtn" onclick="toggleProfileMenu()" 
                                class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm hover:shadow-lg transition-all duration-200 hover:scale-105 border-2 border-white shadow-md">
                            <span id="profileInitials">?</span>
                            <img id="profileImage" class="w-full h-full rounded-full object-cover hidden" alt="Profile">
                        </button>
                        
                        <!-- Profile Menu Dropdown -->
                        <div id="profileMenu" class="absolute right-0 top-12 w-64 bg-white rounded-lg shadow-xl border z-50 transform scale-95 opacity-0 transition-all duration-200 pointer-events-none">
                            <div class="py-2">
                                <div class="px-4 py-3 border-b border-gray-200">
                                    <div class="flex items-center gap-3">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold">
                                            <span id="menuProfileInitials">?</span>
                                            <img id="menuProfileImage" class="w-full h-full rounded-full object-cover hidden" alt="Profile">
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800" id="menuCurrentUser">-</p>
                                            <p class="text-xs text-gray-500" id="menuUserRole">Guru</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="showChangePhoto()" class="profile-menu-item">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Ubah Foto Profil
                                </button>
                                
                                <button onclick="showProfileSettings()" class="profile-menu-item">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Pengaturan Profil
                                </button>
                                
                                <button onclick="showMyClasses()" class="profile-menu-item">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    Kelas Saya
                                </button>
                                
                                <hr class="my-2">
                                
                                <button onclick="logout()" class="profile-menu-item text-red-600 hover:bg-red-50">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Keluar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Login Form -->
        <div id="loginSection" class="max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-gray-800">Login Guru</h2>
                </div>

                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="username" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Masukkan username">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Masukkan password">
                    </div>

                    <button type="submit" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Masuk
                    </button>
                </form>

                <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                    Username atau password salah!
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
                    <button onclick="loginAsAdmin()" 
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        Login Admin
                    </button>
                    <button onclick="showPublicGrades()" 
                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                        Lihat Nilai Siswa (Tanpa Login)
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation Dropdown (Hidden by default) -->
        <div id="navDropdown" class="fixed top-20 left-4 w-64 bg-white rounded-lg shadow-xl border z-40 transform -translate-x-full transition-transform duration-300 ease-in-out opacity-0">
            <div class="py-2">
                <button onclick="showDashboard(); closeNav();" class="nav-item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    Dashboard
                </button>
                <button onclick="showAttendance(); closeNav();" class="nav-item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 4h.01M9 16h.01"></path>
                    </svg>
                    Absensi
                </button>
                <button onclick="showRecap(); closeNav();" class="nav-item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Rekap Absensi
                </button>
                <button onclick="showGrades(); closeNav();" class="nav-item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    Nilai Siswa
                </button>
                <button onclick="showClassManagement(); closeNav();" class="nav-item">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    Kelola Kelas
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboardSection" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-blue-800">Total Absensi</h3>
                            <p class="text-2xl font-bold text-blue-600" id="totalAttendance">0</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-green-800">Kelas Aktif</h3>
                            <p class="text-2xl font-bold text-green-600" id="activeClasses">0</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-yellow-800">Mata Pelajaran</h3>
                            <p class="text-2xl font-bold text-yellow-600" id="totalSubjects">0</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-purple-800">Total Siswa</h3>
                            <p class="text-2xl font-bold text-purple-600" id="totalStudents">0</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Aksi Cepat</h3>
                        <div class="space-y-3">
                            <button onclick="showAttendance()" 
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg transition duration-200">
                                Buat Absensi Baru
                            </button>
                            <button onclick="showGrades()" 
                                    class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition duration-200">
                                Kelola Nilai Siswa
                            </button>
                            <button onclick="showRecap()" 
                                    class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg transition duration-200">
                                Lihat Rekap Absensi
                            </button>
                            <button onclick="showClassManagement()" 
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg transition duration-200">
                                Kelola Kelas
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                        <div id="recentActivity" class="space-y-3">
                            <p class="text-gray-500 text-sm">Belum ada aktivitas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Section -->
        <div id="attendanceSection" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Absensi Siswa</h2>
                    
                    <!-- Class Selection -->
                    <div id="classSelection">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="subjectSelect" onchange="updateClassOptions()" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">-- Pilih Mata Pelajaran --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="classSelect" onchange="checkCanStart()" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">-- Pilih Kelas --</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <button id="startAttendanceBtn" onclick="startAttendance()" disabled
                                    class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-3 px-8 rounded-lg transition duration-200">
                                Mulai Absensi
                            </button>
                        </div>
                    </div>

                    <!-- Attendance Form -->
                    <div id="attendanceForm" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800" id="attendanceTitle">Absensi</h3>
                                <p class="text-gray-600" id="attendanceInfo">-</p>
                            </div>
                            <button onclick="backToSelection()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                Kembali
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-3 text-left">No</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left">Nama Siswa</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center">Status Kehadiran</th>
                                    </tr>
                                </thead>
                                <tbody id="studentList">
                                    <!-- Students will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-6 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <span id="attendanceStats">Hadir: 0 | Alpa: 0 | Sakit: 0 | Izin: 0</span>
                            </div>
                            <button onclick="saveAttendance()" 
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg">
                                Simpan Absensi
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recap Section -->
        <div id="recapSection" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Rekap Absensi</h2>
                        <button onclick="showAttendance()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                            Absensi Baru
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-3 text-left">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Tanggal</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Mata Pelajaran</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center">Hadir</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center">Alpa</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center">Sakit</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center">Izin</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="recapTableBody">
                                <!-- Recap data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="noRecapData" class="text-center py-12 hidden">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Data Absensi</h3>
                        <p class="text-gray-500">Mulai buat absensi pertama Anda</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grades Section -->
        <div id="gradesSection" class="hidden">
            <div class="max-w-full mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Nilai Siswa</h2>
                        <div class="flex gap-3">
                            <button id="editGradesBtn" onclick="toggleEditMode()" 
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                <span id="editBtnText">Edit</span>
                            </button>
                            <button id="saveGradesBtn" onclick="saveGrades()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg hidden">
                                Simpan
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                            <select id="gradesSubjectSelect" onchange="loadGradesData()" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="gradesClassSelect" onchange="loadGradesData()" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Pilih Kelas --</option>
                            </select>
                        </div>
                    </div>

                    <div id="gradesTableContainer" class="hidden overflow-x-auto">
                        <table class="w-full border-collapse text-sm">
                            <thead>
                                <tr class="bg-gray-50 sticky-header">
                                    <th class="border border-gray-300 px-2 py-3 text-center sticky-col min-w-[50px]">No</th>
                                    <th class="border border-gray-300 px-3 py-3 text-left sticky-col-2 min-w-[200px]">Nama</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 1</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 2</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 3</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[80px] bg-blue-100">Formatif 1</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 4</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 5</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 6</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[80px] bg-blue-100">Formatif 2</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 7</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 8</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px]">TP 9</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[80px] bg-blue-100">Formatif 3</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px] bg-yellow-50">PSAT</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px] bg-yellow-50">PSAF</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[80px] bg-green-100">Rata-rata</th>
                                    <th class="border border-gray-300 px-2 py-3 text-center min-w-[60px] bg-green-600 text-white">Nilai</th>
                                </tr>
                            </thead>
                            <tbody id="gradesTableBody">
                                <!-- Grades data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="noGradesData" class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">Pilih Mata Pelajaran dan Kelas</h3>
                        <p class="text-gray-500">Untuk melihat dan mengelola nilai siswa</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Class Management Section -->
        <div id="classManagementSection" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Kelola Kelas</h2>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-4 mb-8">
                        <button onclick="showCreateClass()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Buat Kelas Baru
                        </button>
                        <button onclick="showEditClassList()" 
                                class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit Kelas
                        </button>
                    </div>
                    
                    <!-- Class Overview -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ringkasan Kelas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-4 rounded-lg">
                                <div class="text-2xl font-bold text-indigo-600" id="totalClassesCount">0</div>
                                <div class="text-sm text-gray-600">Total Kelas</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" id="totalStudentsCount">0</div>
                                <div class="text-sm text-gray-600">Total Siswa</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" id="averageClassSize">0</div>
                                <div class="text-sm text-gray-600">Rata-rata per Kelas</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classes List -->
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Daftar Kelas Anda</h3>
                        <div id="classesOverviewList" class="space-y-3">
                            <!-- Classes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Class Section -->
        <div id="createClassSection" class="hidden">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Buat Kelas Baru</h2>
                    
                    <form onsubmit="createNewClass(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" id="newClassName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="Contoh: XII TJKT 1">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran yang Diajarkan</label>
                            <div class="relative">
                                <button type="button" onclick="toggleSubjectDropdown()" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-left flex items-center justify-between">
                                    <span id="selectedSubjectsText" class="text-gray-500">Pilih mata pelajaran untuk kelas ini</span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                
                                <div id="subjectDropdown" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 hidden max-h-60 overflow-y-auto">
                                    <div class="p-3 border-b border-gray-200">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" id="selectAllSubjects" onchange="toggleAllSubjects()" 
                                                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <label for="selectAllSubjects" class="text-sm font-medium text-gray-700">Pilih Semua</label>
                                        </div>
                                    </div>
                                    <div id="subjectCheckboxList" class="p-2">
                                        <!-- Subject checkboxes will be populated here -->
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Pilih mata pelajaran yang akan tersedia untuk kelas ini</p>
                            
                            <div id="selectedSubjectsPreview" class="mt-3 hidden">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Mata Pelajaran Terpilih:</h4>
                                    <div id="selectedSubjectsList" class="flex flex-wrap gap-2">
                                        <!-- Selected subjects will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa</label>
                            <input type="number" id="studentCount" min="1" max="50" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="Masukkan jumlah siswa">
                        </div>
                        
                        <div id="studentNamesContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama-nama Siswa</label>
                            <div id="studentNamesList" class="space-y-2 max-h-60 overflow-y-auto">
                                <!-- Student name inputs will be generated here -->
                            </div>
                        </div>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h4 class="text-sm font-semibold text-blue-800 mb-3">Import dari CSV</h4>
                            <div class="space-y-3">
                                <div>
                                    <input type="file" id="csvFileInput" accept=".csv" 
                                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                                    <p class="text-xs text-blue-600 mt-1">Format CSV: satu nama per baris atau dipisah koma</p>
                                </div>
                                <button type="button" onclick="importFromCSV()" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                    Import CSV
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="button" onclick="generateStudentInputs()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Generate Input Siswa
                            </button>
                            <button type="submit" 
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Buat Kelas
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <button onclick="showClassManagement()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            Kembali ke Kelola Kelas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Class Section -->
        <div id="editClassSection" class="hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Edit Kelas</h2>
                        <button onclick="showClassManagement()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            Kembali
                        </button>
                    </div>
                    
                    <div id="editClassesList" class="space-y-4">
                        <!-- Edit classes list will be populated here -->
                    </div>
                    
                    <div id="noEditClasses" class="text-center py-12 hidden">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Kelas</h3>
                        <p class="text-gray-500 mb-4">Buat kelas pertama Anda untuk mulai mengelola siswa</p>
                        <button onclick="showCreateClass()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg">
                            Buat Kelas Baru
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="adminDashboardSection" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-800">Dashboard Administrator</h2>
                            <p class="text-gray-600">Kelola sistem absensi dan nilai siswa</p>
                        </div>
                        <div class="flex items-center gap-2 text-red-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <span class="font-medium">Mode Administrator</span>
                        </div>
                    </div>
                    
                    <!-- Admin Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-blue-800">Total Guru</h3>
                            <p class="text-2xl font-bold text-blue-600" id="adminTotalTeachers">0</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-green-800">Total Kelas</h3>
                            <p class="text-2xl font-bold text-green-600" id="adminTotalClasses">0</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-yellow-800">Total Siswa</h3>
                            <p class="text-2xl font-bold text-yellow-600" id="adminTotalStudents">0</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-sm font-medium text-purple-800">Total Absensi</h3>
                            <p class="text-2xl font-bold text-purple-600" id="adminTotalAttendance">0</p>
                        </div>
                    </div>
                    
                    <!-- Admin Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Kelola Guru</h3>
                            <div class="space-y-3">
                                <button onclick="showTeacherManagement()" 
                                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Lihat Semua Guru
                                </button>
                                <button onclick="showAddTeacher()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Tambah Guru Baru
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Sistem</h3>
                            <div class="space-y-3">
                                <button onclick="showAllClasses()" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Lihat Semua Kelas
                                </button>
                                <button onclick="showSystemStats()" 
                                        class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Statistik Sistem
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pengaturan</h3>
                            <div class="space-y-3">
                                <button onclick="exportAllData()" 
                                        class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Export Data
                                </button>
                                <button onclick="showAddActivity()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition duration-200">
                                    Tambah Aktivitas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                    <div id="adminRecentActivity" class="space-y-3">
                        <p class="text-gray-500 text-sm">Memuat aktivitas...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Public Grades Section -->
        <div id="publicGradesSection" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Lihat Nilai Siswa</h2>
                        <button onclick="backToLogin()" 
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            Kembali
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Guru</label>
                            <select id="publicTeacherSelect" onchange="loadPublicSubjects()" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Pilih Guru --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                            <select id="publicSubjectSelect" onchange="loadPublicClasses()" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                            </select>
                        </div>
                    </div>

                    <div id="publicClassList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
                        <!-- Class cards will be populated here -->
                    </div>

                    <div id="noPublicData" class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">Pilih Guru dan Mata Pelajaran</h3>
                        <p class="text-gray-500">Untuk melihat nilai siswa</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Attendance Detail Modal -->
    <div id="attendanceDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Detail Absensi</h3>
                <div class="flex gap-3">
                    <button onclick="closeAttendanceDetailModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Tutup
                    </button>
                </div>
            </div>
            <div id="attendanceDetailContent">
                <!-- Content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Grade Detail Modal -->
    <div id="gradeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-7xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Detail Nilai Siswa</h3>
                <div class="flex gap-3">
                    <button onclick="closeGradeDetailModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Tutup
                    </button>
                </div>
            </div>
            <div id="gradeDetailContent">
                <!-- Content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Change Photo Modal -->
    <div id="changePhotoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md mx-4 w-full">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Ubah Foto Profil</h3>
                <button onclick="closeChangePhotoModal()" 
                        class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-2xl border-4 border-white shadow-lg">
                    <span id="previewInitials">?</span>
                    <img id="previewImage" class="w-full h-full rounded-full object-cover hidden" alt="Preview">
                </div>
                <p class="text-gray-600 text-sm">Foto profil saat ini</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Foto Baru</label>
                    <input type="file" id="photoFileInput" accept="image/*" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
                    <p class="text-xs text-gray-500 mt-1">Format: JPG, PNG, GIF (Maks. 2MB)</p>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2"> Tips Foto Profil:</h4>
                    <ul class="text-blue-700 text-xs space-y-1">
                        <li> Gunakan foto dengan wajah yang jelas</li>
                        <li> Ukuran optimal: 400x400 pixel</li>
                        <li> Hindari foto yang terlalu gelap</li>
                        <li> Foto akan dipotong menjadi bentuk bulat</li>
                    </ul>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="uploadProfilePhoto()" 
                            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Simpan Foto
                    </button>
                    <button onclick="removeProfilePhoto()" 
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                        Hapus Foto
                    </button>
                </div>
                
                <button onclick="closeChangePhotoModal()" 
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Batal
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentAttendanceData = {};
        let currentGradesData = {};
        let isEditMode = false;
        let currentDetailData = null;
        let isProfileMenuOpen = false;

        // Teacher data
        const teachers = {
            'ABB88': {
                name: 'Agi Manik Laga, S.Kom',
                password: 'nasigoreng',
                subjects: [],
                classes: []
            },
            'AKUUISANN': {
                name: 'Muhamad Ihsan',
                password: 'akuuisann1212',
                subjects: [],
                classes: []
            }
        };

        // Student data
        const studentsData = {};

        // Utility functions
        function hideAllSections() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('attendanceSection').classList.add('hidden');
            document.getElementById('recapSection').classList.add('hidden');
            document.getElementById('gradesSection').classList.add('hidden');
            document.getElementById('classManagementSection').classList.add('hidden');
            document.getElementById('createClassSection').classList.add('hidden');
            document.getElementById('editClassSection').classList.add('hidden');
            document.getElementById('adminDashboardSection').classList.add('hidden');
            document.getElementById('publicGradesSection').classList.add('hidden');
        }

        function showLoginScreen() {
            hideAllSections();
            document.getElementById('loginSection').classList.remove('hidden');
            // Hide navigation elements on login screen
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('navMenuBtn').classList.add('hidden');
            closeNav();
            closeProfileMenu();
        }

        function showSection(sectionId) {
            hideAllSections();
            document.getElementById(sectionId).classList.remove('hidden');
            // Navigation will be closed by individual nav item clicks
        }

        let isNavOpen = false;

        function toggleNav() {
            const dropdown = document.getElementById('navDropdown');
            const navBtn = document.getElementById('navMenuBtn');
            
            if (!isNavOpen) {
                // Show and animate in
                dropdown.classList.remove('-translate-x-full', 'opacity-0');
                dropdown.classList.add('translate-x-0', 'opacity-100');
                navBtn.classList.add('bg-indigo-700');
                isNavOpen = true;
            } else {
                // Animate out and hide
                dropdown.classList.remove('translate-x-0', 'opacity-100');
                dropdown.classList.add('-translate-x-full', 'opacity-0');
                navBtn.classList.remove('bg-indigo-700');
                isNavOpen = false;
            }
        }

        function closeNav() {
            const dropdown = document.getElementById('navDropdown');
            const navBtn = document.getElementById('navMenuBtn');
            
            if (isNavOpen) {
                dropdown.classList.remove('translate-x-0', 'opacity-100');
                dropdown.classList.add('-translate-x-full', 'opacity-0');
                navBtn.classList.remove('bg-indigo-700');
                isNavOpen = false;
            }
        }

        // Login functions
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // Find matching teacher
            const teacherData = teachers[username];
            
            if (teacherData && teacherData.password === password) {
                currentUser = teacherData;
                
                // Update UI
                document.getElementById('currentUser').textContent = currentUser.name;
                document.getElementById('loginTime').textContent = new Date().toLocaleString('id-ID');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('navMenuBtn').classList.remove('hidden');
                
                // Update profile display
                updateProfileDisplay();
                
                // Load teacher options
                loadTeacherOptions();
                
                // Show dashboard
                showDashboard();
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').classList.add('hidden');
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('loginError').classList.add('hidden');
                }, 3000);
            }
        }

        function logout() {
            currentUser = null;
            currentAttendanceData = {};
            currentGradesData = {};
            isEditMode = false;
            isNavOpen = false;
            isProfileMenuOpen = false;
            
            // Use showLoginScreen to properly hide navigation
            showLoginScreen();
        }

        // Profile menu functions
        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            
            if (!isProfileMenuOpen) {
                menu.classList.add('profile-menu-open');
                isProfileMenuOpen = true;
            } else {
                menu.classList.remove('profile-menu-open');
                isProfileMenuOpen = false;
            }
        }

        function closeProfileMenu() {
            const menu = document.getElementById('profileMenu');
            if (menu && isProfileMenuOpen) {
                menu.classList.remove('profile-menu-open');
                isProfileMenuOpen = false;
            }
        }

        function updateProfileDisplay() {
            if (!currentUser) return;
            
            const initials = getInitials(currentUser.name);
            const profilePhoto = getProfilePhoto(currentUser.name);
            
            // Update header profile
            document.getElementById('profileInitials').textContent = initials;
            document.getElementById('menuProfileInitials').textContent = initials;
            document.getElementById('menuCurrentUser').textContent = currentUser.name;
            document.getElementById('menuUserRole').textContent = currentUser.role === 'admin' ? 'Administrator' : 'Guru';
            
            // Update profile images if exists
            if (profilePhoto) {
                document.getElementById('profileImage').src = profilePhoto;
                document.getElementById('profileImage').classList.remove('hidden');
                document.getElementById('profileInitials').classList.add('hidden');
                
                document.getElementById('menuProfileImage').src = profilePhoto;
                document.getElementById('menuProfileImage').classList.remove('hidden');
                document.getElementById('menuProfileInitials').classList.add('hidden');
            } else {
                document.getElementById('profileImage').classList.add('hidden');
                document.getElementById('profileInitials').classList.remove('hidden');
                
                document.getElementById('menuProfileImage').classList.add('hidden');
                document.getElementById('menuProfileInitials').classList.remove('hidden');
            }
        }

        function getInitials(name) {
            if (!name) return '?';
            const words = name.split(' ');
            if (words.length >= 2) {
                return (words[0][0] + words[1][0]).toUpperCase();
            }
            return name[0].toUpperCase();
        }

        function getProfilePhoto(teacherName) {
            const photoKey = `profile_photo_${teacherName.replace(/\s+/g, '_')}`;
            return localStorage.getItem(photoKey);
        }

        function setProfilePhoto(teacherName, photoData) {
            const photoKey = `profile_photo_${teacherName.replace(/\s+/g, '_')}`;
            localStorage.setItem(photoKey, photoData);
        }

        function removeProfilePhotoData(teacherName) {
            const photoKey = `profile_photo_${teacherName.replace(/\s+/g, '_')}`;
            localStorage.removeItem(photoKey);
        }

        // Profile menu actions
        function showChangePhoto() {
            closeProfileMenu();
            
            // Update preview with current photo
            const initials = getInitials(currentUser.name);
            const currentPhoto = getProfilePhoto(currentUser.name);
            
            document.getElementById('previewInitials').textContent = initials;
            
            if (currentPhoto) {
                document.getElementById('previewImage').src = currentPhoto;
                document.getElementById('previewImage').classList.remove('hidden');
                document.getElementById('previewInitials').classList.add('hidden');
            } else {
                document.getElementById('previewImage').classList.add('hidden');
                document.getElementById('previewInitials').classList.remove('hidden');
            }
            
            // Clear file input
            document.getElementById('photoFileInput').value = '';
            
            // Show modal
            document.getElementById('changePhotoModal').classList.remove('hidden');
            document.getElementById('changePhotoModal').classList.add('flex');
        }

        function closeChangePhotoModal() {
            document.getElementById('changePhotoModal').classList.add('hidden');
            document.getElementById('changePhotoModal').classList.remove('flex');
        }

        function uploadProfilePhoto() {
            const fileInput = document.getElementById('photoFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file foto terlebih dahulu');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('File harus berupa gambar (JPG, PNG, GIF)');
                return;
            }
            
            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('Ukuran file maksimal 2MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // Save to localStorage
                setProfilePhoto(currentUser.name, imageData);
                
                // Update display
                updateProfileDisplay();
                
                // Close modal
                closeChangePhotoModal();
                
                alert(' Foto profil berhasil diperbarui!');
            };
            
            reader.onerror = function() {
                alert(' Gagal membaca file foto');
            };
            
            reader.readAsDataURL(file);
        }

        function removeProfilePhoto() {
            const confirmed = confirm('Hapus foto profil?\n\nFoto akan kembali ke inisial nama.');
            
            if (confirmed) {
                // Remove from localStorage
                removeProfilePhotoData(currentUser.name);
                
                // Update display
                updateProfileDisplay();
                
                // Close modal
                closeChangePhotoModal();
                
                alert(' Foto profil berhasil dihapus!');
            }
        }

        function showProfileSettings() {
            closeProfileMenu();
            alert(' Fitur Pengaturan Profil sedang dalam pengembangan\n\nFitur yang akan tersedia:\n Ubah nama tampilan\n Ubah password\n Pengaturan notifikasi\n Preferensi tampilan');
        }

        function showMyClasses() {
            closeProfileMenu();
            showClassManagement();
        }

        function loadTeacherOptions() {
            if (!currentUser) return;
            
            // Load subjects
            const subjectSelects = ['subjectSelect', 'gradesSubjectSelect'];
            subjectSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
                currentUser.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    select.appendChild(option);
                });
            });
            
            // Load classes
            const classSelects = ['classSelect', 'gradesClassSelect'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                currentUser.classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    select.appendChild(option);
                });
            });
        }

        // Navigation functions
        function showDashboard() {
            if (currentUser && currentUser.role === 'admin') {
                showAdminDashboard();
            } else {
                showSection('dashboardSection');
                updateDashboardStats();
            }
        }

        function showAttendance() {
            showSection('attendanceSection');
            document.getElementById('classSelection').classList.remove('hidden');
            document.getElementById('attendanceForm').classList.add('hidden');
        }

        function showRecap() {
            showSection('recapSection');
            loadRecapData();
        }

        function showGrades() {
            showSection('gradesSection');
            loadGradesOptions();
        }

        function showClassManagement() {
            showSection('classManagementSection');
            loadClassManagementData();
        }

        function showCreateClass() {
            showSection('createClassSection');
            loadTeacherSubjects();
        }
        
        let selectedSubjectsForClass = [];

        function loadTeacherSubjects() {
            if (!currentUser) return;
            
            if (currentUser.subjects.length === 0) {
                document.getElementById('selectedSubjectsText').textContent = 'Belum ada mata pelajaran tersedia';
                document.getElementById('selectedSubjectsText').className = 'text-red-500';
                return;
            }
            
            // Reset selected subjects
            selectedSubjectsForClass = [];
            
            // Populate checkbox list
            const checkboxContainer = document.getElementById('subjectCheckboxList');
            checkboxContainer.innerHTML = '';
            
            currentUser.subjects.forEach((subject, index) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center gap-3 p-2 hover:bg-gray-50 rounded';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="subject_${index}" value="${subject}" 
                           onchange="updateSelectedSubjects()" 
                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="subject_${index}" class="text-sm text-gray-700 flex-1 cursor-pointer">${subject}</label>
                `;
                checkboxContainer.appendChild(checkboxDiv);
            });
            
            updateSelectedSubjectsDisplay();
        }

        function toggleSubjectDropdown() {
            const dropdown = document.getElementById('subjectDropdown');
            dropdown.classList.toggle('hidden');
        }

        function toggleAllSubjects() {
            const selectAllCheckbox = document.getElementById('selectAllSubjects');
            const subjectCheckboxes = document.querySelectorAll('#subjectCheckboxList input[type="checkbox"]');
            
            subjectCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedSubjects();
        }

        function updateSelectedSubjects() {
            const checkboxes = document.querySelectorAll('#subjectCheckboxList input[type="checkbox"]:checked');
            selectedSubjectsForClass = Array.from(checkboxes).map(cb => cb.value);
            
            // Update "Select All" checkbox state
            const selectAllCheckbox = document.getElementById('selectAllSubjects');
            const totalCheckboxes = document.querySelectorAll('#subjectCheckboxList input[type="checkbox"]').length;
            const checkedCheckboxes = checkboxes.length;
            
            if (checkedCheckboxes === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes === totalCheckboxes) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            updateSelectedSubjectsDisplay();
        }

        function updateSelectedSubjectsDisplay() {
            const selectedText = document.getElementById('selectedSubjectsText');
            const previewContainer = document.getElementById('selectedSubjectsPreview');
            const selectedList = document.getElementById('selectedSubjectsList');
            
            if (selectedSubjectsForClass.length === 0) {
                selectedText.textContent = 'Pilih mata pelajaran untuk kelas ini';
                selectedText.className = 'text-gray-500';
                previewContainer.classList.add('hidden');
            } else {
                selectedText.textContent = `${selectedSubjectsForClass.length} mata pelajaran dipilih`;
                selectedText.className = 'text-gray-800 font-medium';
                
                // Show preview
                previewContainer.classList.remove('hidden');
                selectedList.innerHTML = selectedSubjectsForClass.map(subject => `
                    <span class="inline-flex items-center gap-1 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">
                        ${subject}
                        <button type="button" onclick="removeSelectedSubject('${subject}')" 
                                class="text-blue-600 hover:text-blue-800">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </span>
                `).join('');
            }
        }

        function removeSelectedSubject(subjectToRemove) {
            // Uncheck the checkbox
            const checkboxes = document.querySelectorAll('#subjectCheckboxList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === subjectToRemove) {
                    checkbox.checked = false;
                }
            });
            
            // Update selected subjects
            updateSelectedSubjects();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('subjectDropdown');
            const button = event.target.closest('button[onclick="toggleSubjectDropdown()"]');
            const dropdownContent = event.target.closest('#subjectDropdown');
            
            if (!button && !dropdownContent && dropdown) {
                dropdown.classList.add('hidden');
            }
        });

        function showEditClassList() {
            showSection('editClassSection');
            loadEditClassesList();
        }

        function showPublicGrades() {
            showSection('publicGradesSection');
            loadPublicTeachers();
        }

        function backToLogin() {
            showLoginScreen();
        }

        function loginAsAdmin() {
            // Create admin login modal
            const modal = document.createElement('div');
            modal.id = 'adminLoginModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md mx-4 w-full">
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-semibold text-gray-800">Login Admin</h2>
                        <p class="text-gray-600 text-sm mt-2">Akses khusus administrator sistem</p>
                    </div>

                    <form onsubmit="handleAdminLogin(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username Admin</label>
                            <input type="text" id="adminUsername" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                   placeholder="Masukkan username admin">
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password Admin</label>
                            <input type="password" id="adminPassword" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                   placeholder="Masukkan password admin">
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" 
                                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                Masuk Admin
                            </button>
                            <button type="button" onclick="closeAdminLoginModal()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                                Batal
                            </button>
                        </div>
                    </form>

                    <div id="adminLoginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                        Username atau password admin salah!
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeAdminLoginModal() {
            const modal = document.getElementById('adminLoginModal');
            if (modal) {
                modal.remove();
            }
        }

        function handleAdminLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            // Admin credentials
            if (username === 'admin' && password === 'admin123') {
                // Set admin user
                currentUser = {
                    name: 'Administrator',
                    role: 'admin',
                    subjects: [],
                    classes: []
                };
                
                // Update UI
                document.getElementById('currentUser').textContent = 'Administrator (Admin)';
                document.getElementById('loginTime').textContent = new Date().toLocaleString('id-ID');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('navMenuBtn').classList.remove('hidden');
                
                // Update profile display
                updateProfileDisplay();
                
                // Close modal
                closeAdminLoginModal();
                
                // Show admin dashboard
                showAdminDashboard();
                
            } else {
                document.getElementById('adminLoginError').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('adminLoginError').classList.add('hidden');
                }, 3000);
            }
        }

        function showAdminDashboard() {
            showSection('adminDashboardSection');
            updateAdminStats();
            loadAdminRecentActivity();
        }

        function updateAdminStats() {
            // Count teachers
            const totalTeachers = Object.keys(teachers).length;
            document.getElementById('adminTotalTeachers').textContent = totalTeachers;
            
            // Count classes
            const totalClasses = Object.keys(studentsData).length;
            document.getElementById('adminTotalClasses').textContent = totalClasses;
            
            // Count students
            let totalStudents = 0;
            Object.values(studentsData).forEach(classData => {
                const students = Array.isArray(classData) ? classData : classData.students;
                totalStudents += students.length;
            });
            document.getElementById('adminTotalStudents').textContent = totalStudents;
            
            // Count attendance records
            let totalAttendance = 0;
            Object.values(teachers).forEach(teacher => {
                const attendanceKey = `attendance_${teacher.name.replace(/\s+/g, '_')}`;
                const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
                totalAttendance += attendanceHistory.length;
            });
            document.getElementById('adminTotalAttendance').textContent = totalAttendance;
        }

        function loadAdminRecentActivity() {
            const activityContainer = document.getElementById('adminRecentActivity');
            const activities = [];
            
            // Load admin activities
            const adminActivities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
            adminActivities.forEach(activity => {
                activities.push({
                    type: 'admin_activity',
                    id: activity.id,
                    activityType: activity.type,
                    title: activity.title,
                    description: activity.description,
                    priority: activity.priority,
                    targetTeacher: activity.targetTeacher,
                    location: activity.location,
                    date: new Date(activity.createdAt),
                    time: new Date(activity.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                    createdBy: activity.createdBy
                });
            });
            
            // Collect recent activities from all teachers
            Object.values(teachers).forEach(teacher => {
                const attendanceKey = `attendance_${teacher.name.replace(/\s+/g, '_')}`;
                const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
                
                attendanceHistory.forEach(record => {
                    activities.push({
                        type: 'attendance',
                        teacher: teacher.name,
                        subject: record.subject,
                        class: record.class,
                        date: new Date(record.date),
                        time: record.time
                    });
                });
            });
            
            // Sort by date (newest first)
            activities.sort((a, b) => b.date - a.date);
            
            // Show last 15 activities
            const recentActivities = activities.slice(0, 15);
            
            if (recentActivities.length === 0) {
                activityContainer.innerHTML = '<p class="text-gray-500 text-sm">Belum ada aktivitas</p>';
                return;
            }
            
            activityContainer.innerHTML = recentActivities.map(activity => {
                if (activity.type === 'admin_activity') {
                    // Get type and priority emojis
                    const typeEmojis = {
                        'announcement': '',
                        'event': '',
                        'reminder': '',
                        'maintenance': '',
                        'update': ''
                    };
                    
                    const priorityColors = {
                        'low': 'bg-green-100 text-green-800',
                        'medium': 'bg-yellow-100 text-yellow-800',
                        'high': 'bg-orange-100 text-orange-800',
                        'urgent': 'bg-red-100 text-red-800'
                    };
                    
                    const typeEmoji = typeEmojis[activity.activityType] || '';
                    const priorityColor = priorityColors[activity.priority] || 'bg-gray-100 text-gray-800';
                    
                    return `
                        <div class="flex items-start justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-start gap-3 flex-1">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-sm">${typeEmoji}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="text-sm font-medium text-gray-800 truncate">
                                            ${activity.title}
                                        </p>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColor} flex-shrink-0">
                                            ${activity.priority.charAt(0).toUpperCase() + activity.priority.slice(1)}
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1 line-clamp-2">
                                        ${activity.description.length > 60 ? activity.description.substring(0, 60) + '...' : activity.description}
                                    </p>
                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                        <span>Admin</span>
                                        ${activity.targetTeacher ? `<span> ${activity.targetTeacher}</span>` : '<span> Semua Guru</span>'}
                                        ${activity.location ? `<span> ${activity.location}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-start gap-2 flex-shrink-0 ml-3">
                                <div class="text-right">
                                    <p class="text-xs text-gray-500">${activity.date.toLocaleDateString('id-ID')}</p>
                                    <p class="text-xs text-gray-500">${activity.time}</p>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <button onclick="editAdminActivity(${activity.id})" 
                                            class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-1 rounded text-xs flex items-center gap-1"
                                            title="Edit aktivitas">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="deleteAdminActivity(${activity.id})" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs flex items-center gap-1"
                                            title="Hapus aktivitas">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Regular attendance activity
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 4h.01M9 16h.01"></path>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">
                                        ${activity.teacher} - Absensi ${activity.subject}
                                    </p>
                                    <p class="text-xs text-gray-600">${activity.class}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500">${activity.date.toLocaleDateString('id-ID')}</p>
                                <p class="text-xs text-gray-500">${activity.time}</p>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Admin management functions
        function showTeacherManagement() {
            // Create teacher management modal
            const modal = document.createElement('div');
            modal.id = 'teacherManagementModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const teacherList = Object.entries(teachers).map(([username, teacher]) => {
                const totalClasses = teacher.classes ? teacher.classes.length : 0;
                const totalSubjects = teacher.subjects ? teacher.subjects.length : 0;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800">${teacher.name}</h4>
                                <p class="text-sm text-gray-600">Username: ${username}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editTeacher('${username}')" 
                                        class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                                    Edit
                                </button>
                                <button onclick="deleteTeacher('${username}')" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    Hapus
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-blue-50 p-2 rounded">
                                <span class="text-blue-800 font-medium">${totalClasses}</span>
                                <span class="text-blue-600"> Kelas</span>
                            </div>
                            <div class="bg-green-50 p-2 rounded">
                                <span class="text-green-800 font-medium">${totalSubjects}</span>
                                <span class="text-green-600"> Mapel</span>
                            </div>
                        </div>
                        ${teacher.subjects && teacher.subjects.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-gray-500 mb-1">Mata Pelajaran:</p>
                                <p class="text-xs text-gray-700">${teacher.subjects.join(', ')}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-4xl mx-4 max-h-[90vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Kelola Guru</h3>
                        <button onclick="closeTeacherManagementModal()" 
                                class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-medium text-gray-800">Daftar Guru Terdaftar</h4>
                            <button onclick="showAddTeacher()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Tambah Guru
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${teacherList}
                        </div>
                        
                        ${Object.keys(teachers).length === 0 ? `
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">Belum Ada Guru Terdaftar</h3>
                                <p class="text-gray-500 mb-4">Tambah guru pertama untuk memulai</p>
                                <button onclick="showAddTeacher()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                    Tambah Guru Pertama
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeTeacherManagementModal() {
            const modal = document.getElementById('teacherManagementModal');
            if (modal) {
                modal.remove();
            }
        }

        function showAddTeacher() {
            // Close teacher management modal if open
            closeTeacherManagementModal();
            
            // Create add teacher modal
            const modal = document.createElement('div');
            modal.id = 'addTeacherModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Tambah Guru Baru</h3>
                        <button onclick="closeAddTeacherModal()" 
                                class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="createNewTeacher(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap Guru</label>
                            <input type="text" id="newTeacherName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                   placeholder="Contoh: Dr. Ahmad Wijaya, S.Pd">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="newTeacherUsername" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                   placeholder="Username untuk login (tanpa spasi)">
                            <p class="text-xs text-gray-500 mt-1">Username harus unik dan tidak boleh sama dengan yang sudah ada</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="newTeacherPassword" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                   placeholder="Password untuk login">
                            <p class="text-xs text-gray-500 mt-1">Minimal 6 karakter</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran yang Diajarkan</label>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" id="newSubjectInput" 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                           placeholder="Masukkan nama mata pelajaran"
                                           onkeypress="if(event.key==='Enter'){event.preventDefault();addNewSubject();}">
                                    <button type="button" onclick="addNewSubject()" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                        Tambah
                                    </button>
                                </div>
                                <div id="newTeacherSubjectsList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                                    <p class="text-gray-500 text-sm text-center" id="noSubjectsText">Belum ada mata pelajaran ditambahkan</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Tambahkan mata pelajaran satu per satu dengan mengetik nama dan klik Tambah</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-blue-800 mb-2"> Informasi:</h4>
                            <ul class="text-blue-700 text-sm space-y-1">
                                <li> Guru dapat membuat kelas sendiri setelah login</li>
                                <li> Mata pelajaran yang dipilih akan tersedia untuk kelas yang dibuat</li>
                                <li> Username dan password dapat diubah nanti oleh admin</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" 
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Buat Akun Guru
                            </button>
                            <button type="button" onclick="closeAddTeacherModal()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadAvailableSubjects();
        }

        let newTeacherSubjects = [];

        function loadAvailableSubjects() {
            // Reset subjects array for new teacher
            newTeacherSubjects = [];
            const container = document.getElementById('newTeacherSubjectsList');
            if (container) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center" id="noSubjectsText">Belum ada mata pelajaran ditambahkan</p>';
            }
        }

        function addNewSubject() {
            const input = document.getElementById('newSubjectInput');
            const subjectName = input.value.trim();
            
            if (!subjectName) {
                alert('Masukkan nama mata pelajaran');
                return;
            }
            
            if (newTeacherSubjects.includes(subjectName)) {
                alert('Mata pelajaran sudah ada dalam daftar');
                input.value = '';
                return;
            }
            
            // Add to array
            newTeacherSubjects.push(subjectName);
            
            // Update display
            updateNewSubjectsDisplay();
            
            // Clear input
            input.value = '';
        }

        function updateNewSubjectsDisplay() {
            const container = document.getElementById('newTeacherSubjectsList');
            const noText = document.getElementById('noSubjectsText');
            
            if (newTeacherSubjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center" id="noSubjectsText">Belum ada mata pelajaran ditambahkan</p>';
                return;
            }
            
            container.innerHTML = newTeacherSubjects.map((subject, index) => `
                <div class="flex items-center justify-between bg-white p-2 rounded border">
                    <span class="text-sm text-gray-700">${subject}</span>
                    <button type="button" onclick="removeNewSubject(${index})" 
                            class="text-red-500 hover:text-red-700 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeNewSubject(index) {
            newTeacherSubjects.splice(index, 1);
            updateNewSubjectsDisplay();
        }

        function createNewTeacher(event) {
            event.preventDefault();
            
            const name = document.getElementById('newTeacherName').value.trim();
            const username = document.getElementById('newTeacherUsername').value.trim();
            const password = document.getElementById('newTeacherPassword').value.trim();
            
            if (!name || !username || !password) {
                alert('Mohon lengkapi semua field yang wajib diisi');
                return;
            }
            
            if (password.length < 6) {
                alert('Password minimal 6 karakter');
                return;
            }
            
            // Check if username already exists
            if (teachers[username]) {
                alert('Username sudah digunakan! Pilih username lain.');
                return;
            }
            
            // Get selected subjects from the manual input array
            if (newTeacherSubjects.length === 0) {
                alert('Tambahkan minimal satu mata pelajaran');
                return;
            }
            
            const selectedSubjects = [...newTeacherSubjects];
            
            // Create new teacher
            teachers[username] = {
                name: name,
                password: password,
                subjects: selectedSubjects,
                classes: []
            };
            
            // Save to localStorage
            localStorage.setItem('teachersData', JSON.stringify(teachers));
            
            alert(` GURU BERHASIL DITAMBAHKAN!\n\n Detail Akun:\n Nama: ${name}\n Username: ${username}\n Password: ${password}\n Mata Pelajaran: ${selectedSubjects.length} mapel\n\n Mata Pelajaran:\n${selectedSubjects.map(s => ` ${s}`).join('\n')}\n\n Guru dapat login menggunakan username dan password ini.\n Guru dapat membuat kelas sendiri setelah login.`);
            
            // Reset subjects array
            newTeacherSubjects = [];
            
            // Close modal and refresh admin stats
            closeAddTeacherModal();
            updateAdminStats();
            loadAdminRecentActivity();
        }

        function closeAddTeacherModal() {
            const modal = document.getElementById('addTeacherModal');
            if (modal) {
                modal.remove();
            }
        }

        function editTeacher(username) {
            const teacher = teachers[username];
            if (!teacher) return;
            
            // Close teacher management modal if open
            closeTeacherManagementModal();
            
            // Create edit teacher modal
            const modal = document.createElement('div');
            modal.id = 'editTeacherModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Edit Guru</h3>
                        <button onclick="closeEditTeacherModal()" 
                                class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="updateTeacher(event, '${username}')" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap Guru</label>
                            <input type="text" id="editTeacherName" value="${teacher.name}" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="editTeacherUsername" value="${username}" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            <p class="text-xs text-gray-500 mt-1">Username harus unik dan tidak boleh sama dengan yang sudah ada</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru</label>
                            <input type="password" id="editTeacherPassword" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                   placeholder="Kosongkan jika tidak ingin mengubah password">
                            <p class="text-xs text-gray-500 mt-1">Minimal 6 karakter (kosongkan jika tidak ingin mengubah)</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran yang Diajarkan</label>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" id="editSubjectInput" 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                                           placeholder="Masukkan nama mata pelajaran"
                                           onkeypress="if(event.key==='Enter'){event.preventDefault();addEditSubject();}">
                                    <button type="button" onclick="addEditSubject()" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                        Tambah
                                    </button>
                                </div>
                                <div id="editTeacherSubjectsList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                                    <!-- Current subjects will be populated here -->
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Tambahkan mata pelajaran satu per satu dengan mengetik nama dan klik Tambah</p>
                        </div>
                        
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-orange-800 mb-2"> Statistik Guru:</h4>
                            <div class="grid grid-cols-2 gap-4 text-orange-700 text-sm">
                                <div>
                                    <span class="font-medium">${teacher.classes ? teacher.classes.length : 0}</span> Kelas Aktif
                                </div>
                                <div>
                                    <span class="font-medium">${teacher.subjects ? teacher.subjects.length : 0}</span> Mata Pelajaran
                                </div>
                            </div>
                            ${teacher.classes && teacher.classes.length > 0 ? `
                                <div class="mt-2 pt-2 border-t border-orange-200">
                                    <p class="text-xs text-orange-600">Kelas: ${teacher.classes.join(', ')}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" 
                                    class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Simpan Perubahan
                            </button>
                            <button type="button" onclick="closeEditTeacherModal()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadEditAvailableSubjects(teacher.subjects || []);
        }

        let editTeacherSubjects = [];

        function loadEditAvailableSubjects(currentSubjects) {
            // Initialize with current subjects
            editTeacherSubjects = [...currentSubjects];
            updateEditSubjectsDisplay();
        }

        function addEditSubject() {
            const input = document.getElementById('editSubjectInput');
            const subjectName = input.value.trim();
            
            if (!subjectName) {
                alert('Masukkan nama mata pelajaran');
                return;
            }
            
            if (editTeacherSubjects.includes(subjectName)) {
                alert('Mata pelajaran sudah ada dalam daftar');
                input.value = '';
                return;
            }
            
            // Add to array
            editTeacherSubjects.push(subjectName);
            
            // Update display
            updateEditSubjectsDisplay();
            
            // Clear input
            input.value = '';
        }

        function updateEditSubjectsDisplay() {
            const container = document.getElementById('editTeacherSubjectsList');
            
            if (editTeacherSubjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center">Belum ada mata pelajaran ditambahkan</p>';
                return;
            }
            
            container.innerHTML = editTeacherSubjects.map((subject, index) => `
                <div class="flex items-center justify-between bg-white p-2 rounded border">
                    <span class="text-sm text-gray-700">${subject}</span>
                    <button type="button" onclick="removeEditSubject(${index})" 
                            class="text-red-500 hover:text-red-700 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeEditSubject(index) {
            editTeacherSubjects.splice(index, 1);
            updateEditSubjectsDisplay();
        }

        function updateTeacher(event, originalUsername) {
            event.preventDefault();
            
            const name = document.getElementById('editTeacherName').value.trim();
            const newUsername = document.getElementById('editTeacherUsername').value.trim();
            const password = document.getElementById('editTeacherPassword').value.trim();
            
            if (!name || !newUsername) {
                alert('Mohon lengkapi nama dan username');
                return;
            }
            
            if (password && password.length < 6) {
                alert('Password minimal 6 karakter');
                return;
            }
            
            // Check if new username already exists (and it's different from original)
            if (newUsername !== originalUsername && teachers[newUsername]) {
                alert('Username sudah digunakan! Pilih username lain.');
                return;
            }
            
            // Get selected subjects from the manual input array
            if (editTeacherSubjects.length === 0) {
                alert('Tambahkan minimal satu mata pelajaran');
                return;
            }
            
            const selectedSubjects = [...editTeacherSubjects];
            
            const originalTeacher = teachers[originalUsername];
            const oldSubjects = originalTeacher.subjects || [];
            const oldClasses = originalTeacher.classes || [];
            
            // Update teacher data
            const updatedTeacher = {
                name: name,
                password: password || originalTeacher.password, // Keep old password if not changed
                subjects: selectedSubjects,
                classes: [...oldClasses] // Keep existing classes
            };
            
            // If username changed, handle the rename
            if (newUsername !== originalUsername) {
                // Remove old username entry
                delete teachers[originalUsername];
                
                // Add with new username
                teachers[newUsername] = updatedTeacher;
                
                // Update attendance data keys
                const oldAttendanceKey = `attendance_${originalTeacher.name.replace(/\s+/g, '_')}`;
                const newAttendanceKey = `attendance_${name.replace(/\s+/g, '_')}`;
                
                if (oldAttendanceKey !== newAttendanceKey) {
                    const attendanceData = localStorage.getItem(oldAttendanceKey);
                    if (attendanceData) {
                        localStorage.setItem(newAttendanceKey, attendanceData);
                        localStorage.removeItem(oldAttendanceKey);
                    }
                }
                
                // Update grades data keys for all subjects and classes
                oldSubjects.forEach(subject => {
                    oldClasses.forEach(className => {
                        const oldGradesKey = `grades_${originalTeacher.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                        const newGradesKey = `grades_${name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                        
                        if (oldGradesKey !== newGradesKey) {
                            const gradesData = localStorage.getItem(oldGradesKey);
                            if (gradesData) {
                                localStorage.setItem(newGradesKey, gradesData);
                                localStorage.removeItem(oldGradesKey);
                            }
                        }
                    });
                });
                
                // Update studentsData teacher references
                Object.keys(studentsData).forEach(className => {
                    const classData = studentsData[className];
                    if (!Array.isArray(classData) && classData.teacher === originalTeacher.name) {
                        classData.teacher = name;
                    }
                });
                
            } else {
                // Just update existing entry
                teachers[originalUsername] = updatedTeacher;
                
                // Update attendance data if name changed
                if (name !== originalTeacher.name) {
                    const oldAttendanceKey = `attendance_${originalTeacher.name.replace(/\s+/g, '_')}`;
                    const newAttendanceKey = `attendance_${name.replace(/\s+/g, '_')}`;
                    
                    const attendanceData = localStorage.getItem(oldAttendanceKey);
                    if (attendanceData) {
                        localStorage.setItem(newAttendanceKey, attendanceData);
                        localStorage.removeItem(oldAttendanceKey);
                    }
                    
                    // Update grades data keys
                    oldSubjects.forEach(subject => {
                        oldClasses.forEach(className => {
                            const oldGradesKey = `grades_${originalTeacher.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                            const newGradesKey = `grades_${name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                            
                            const gradesData = localStorage.getItem(oldGradesKey);
                            if (gradesData) {
                                localStorage.setItem(newGradesKey, gradesData);
                                localStorage.removeItem(oldGradesKey);
                            }
                        });
                    });
                    
                    // Update studentsData teacher references
                    Object.keys(studentsData).forEach(className => {
                        const classData = studentsData[className];
                        if (!Array.isArray(classData) && classData.teacher === originalTeacher.name) {
                            classData.teacher = name;
                        }
                    });
                }
            }
            
            // Handle subject changes - create grades data for new subjects
            const newSubjects = selectedSubjects.filter(subject => !oldSubjects.includes(subject));
            const removedSubjects = oldSubjects.filter(subject => !selectedSubjects.includes(subject));
            
            // Create grades data for new subjects
            newSubjects.forEach(subject => {
                oldClasses.forEach(className => {
                    const classData = studentsData[className];
                    if (classData) {
                        const students = Array.isArray(classData) ? classData : classData.students;
                        const gradesKey = `grades_${name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                        
                        const initialGradesData = {};
                        students.forEach(student => {
                            initialGradesData[student] = {
                                tp1: '', tp2: '', tp3: '', formatif1: '',
                                tp4: '', tp5: '', tp6: '', formatif2: '',
                                tp7: '', tp8: '', tp9: '', formatif3: '',
                                psat: '', psaf: ''
                            };
                        });
                        
                        localStorage.setItem(gradesKey, JSON.stringify(initialGradesData));
                    }
                });
            });
            
            // Remove grades data for removed subjects
            removedSubjects.forEach(subject => {
                oldClasses.forEach(className => {
                    const gradesKey = `grades_${name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                    localStorage.removeItem(gradesKey);
                });
            });
            
            // Update class subjects data
            oldClasses.forEach(className => {
                const classData = studentsData[className];
                if (classData && !Array.isArray(classData)) {
                    classData.subjects = selectedSubjects;
                }
            });
            
            // Save all updated data
            localStorage.setItem('teachersData', JSON.stringify(teachers));
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            
            // Update current user if this is the logged-in teacher
            if (currentUser && currentUser.name === originalTeacher.name) {
                currentUser.name = name;
                currentUser.subjects = selectedSubjects;
                document.getElementById('currentUser').textContent = name;
                loadTeacherOptions(); // Refresh options in current session
            }
            
            // Show success message
            const changes = [];
            if (name !== originalTeacher.name) changes.push(` Nama: ${originalTeacher.name}  ${name}`);
            if (newUsername !== originalUsername) changes.push(` Username: ${originalUsername}  ${newUsername}`);
            if (password) changes.push(` Password: Diperbarui`);
            if (newSubjects.length > 0) changes.push(` Mata pelajaran baru: ${newSubjects.join(', ')}`);
            if (removedSubjects.length > 0) changes.push(` Mata pelajaran dihapus: ${removedSubjects.join(', ')}`);
            
            alert(` DATA GURU BERHASIL DIPERBARUI!\n\n Perubahan yang disimpan:\n${changes.join('\n')}\n\n Status:\n Total mata pelajaran: ${selectedSubjects.length}\n Kelas aktif: ${oldClasses.length}\n Data nilai dan absensi: Tetap tersimpan\n\n Sistem telah diperbarui secara otomatis.`);
            
            // Reset subjects array
            editTeacherSubjects = [];
            
            // Close modal and refresh
            closeEditTeacherModal();
            updateAdminStats();
            loadAdminRecentActivity();
        }

        function closeEditTeacherModal() {
            const modal = document.getElementById('editTeacherModal');
            if (modal) {
                modal.remove();
            }
        }

        function deleteTeacher(username) {
            const teacher = teachers[username];
            if (!teacher) return;
            
            const confirmed = confirm(` HAPUS GURU\n\nAnda akan menghapus:\n ${teacher.name} (${username})\n ${teacher.subjects.length} mata pelajaran\n ${teacher.classes.length} kelas\n\n Semua data guru ini akan hilang:\n Akun login\n Data kelas yang dibuat\n Riwayat absensi\n Data nilai siswa\n\nTindakan ini TIDAK DAPAT DIBATALKAN!\n\nLanjutkan hapus guru?`);
            
            if (confirmed) {
                // Remove teacher data
                delete teachers[username];
                
                // Remove related data
                teacher.classes.forEach(className => {
                    delete studentsData[className];
                });
                
                // Remove attendance and grades data
                const attendanceKey = `attendance_${teacher.name.replace(/\s+/g, '_')}`;
                localStorage.removeItem(attendanceKey);
                
                teacher.subjects.forEach(subject => {
                    teacher.classes.forEach(className => {
                        const gradesKey = `grades_${teacher.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                        localStorage.removeItem(gradesKey);
                    });
                });
                
                // Save updated data
                localStorage.setItem('teachersData', JSON.stringify(teachers));
                localStorage.setItem('studentsData', JSON.stringify(studentsData));
                
                alert(` Guru ${teacher.name} berhasil dihapus!\n\n Data yang dihapus:\n Akun login\n ${teacher.classes.length} kelas\n Semua data absensi dan nilai\n\n Sistem telah diperbarui.`);
                
                // Refresh modals and stats
                closeTeacherManagementModal();
                updateAdminStats();
                loadAdminRecentActivity();
            }
        }

        function showAllClasses() {
            alert(' Fitur Lihat Semua Kelas sedang dalam pengembangan\n\nFitur yang akan tersedia:\n Daftar semua kelas di sistem\n Detail siswa per kelas\n Statistik per kelas\n Export data kelas');
        }

        function showSystemStats() {
            alert(' Fitur Statistik Sistem sedang dalam pengembangan\n\nFitur yang akan tersedia:\n Grafik aktivitas harian\n Statistik kehadiran siswa\n Laporan nilai per mata pelajaran\n Analisis performa sistem');
        }

        function exportAllData() {
            alert(' Fitur Export Data sedang dalam pengembangan\n\nFitur yang akan tersedia:\n Export semua data ke Excel\n Export data per guru\n Export data per kelas\n Backup sistem lengkap');
        }

        function showAddActivity() {
            // Create add activity modal
            const modal = document.createElement('div');
            modal.id = 'addActivityModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Get all teachers for selection
            const teacherOptions = Object.values(teachers).map(teacher => 
                `<option value="${teacher.name}">${teacher.name}</option>`
            ).join('');
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800"> Tambah Aktivitas Baru</h3>
                            <p class="text-gray-600 text-sm">Buat aktivitas atau pengumuman untuk sistem</p>
                        </div>
                        <button onclick="closeAddActivityModal()" 
                                class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="createNewActivity(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Aktivitas</label>
                            <select id="activityType" onchange="updateActivityForm()" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <option value="">-- Pilih Jenis Aktivitas --</option>
                                <option value="announcement"> Pengumuman</option>
                                <option value="event"> Acara/Event</option>
                                <option value="reminder"> Pengingat</option>
                                <option value="maintenance"> Maintenance Sistem</option>
                                <option value="update"> Update Sistem</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Judul Aktivitas</label>
                            <input type="text" id="activityTitle" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                   placeholder="Masukkan judul aktivitas">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea id="activityDescription" rows="4" required
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                      placeholder="Jelaskan detail aktivitas atau pengumuman"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="activityDate" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Waktu</label>
                                <input type="time" id="activityTime" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Guru (Opsional)</label>
                            <select id="targetTeacher" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <option value="">-- Semua Guru --</option>
                                ${teacherOptions}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Kosongkan jika aktivitas untuk semua guru</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioritas</label>
                            <select id="activityPriority" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                                <option value="low"> Rendah</option>
                                <option value="medium" selected> Sedang</option>
                                <option value="high"> Tinggi</option>
                                <option value="urgent"> Mendesak</option>
                            </select>
                        </div>
                        
                        <div id="eventSpecificFields" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi (untuk Event)</label>
                                <input type="text" id="eventLocation"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                       placeholder="Lokasi acara">
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-blue-800 mb-2"> Informasi:</h4>
                            <ul class="text-blue-700 text-sm space-y-1">
                                <li> Aktivitas akan muncul di dashboard semua guru</li>
                                <li> Guru akan melihat notifikasi untuk aktivitas prioritas tinggi</li>
                                <li> Aktivitas dapat diedit atau dihapus setelah dibuat</li>
                                <li> Riwayat aktivitas tersimpan dalam sistem</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" 
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Buat Aktivitas
                            </button>
                            <button type="button" onclick="closeAddActivityModal()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date and time
            const now = new Date();
            document.getElementById('activityDate').value = now.toISOString().split('T')[0];
            document.getElementById('activityTime').value = now.toTimeString().slice(0, 5);
        }
        
        function updateActivityForm() {
            const activityType = document.getElementById('activityType').value;
            const eventFields = document.getElementById('eventSpecificFields');
            
            if (activityType === 'event') {
                eventFields.classList.remove('hidden');
                document.getElementById('eventLocation').required = true;
            } else {
                eventFields.classList.add('hidden');
                document.getElementById('eventLocation').required = false;
            }
        }
        
        function createNewActivity(event) {
            event.preventDefault();
            
            const activityData = {
                id: Date.now(),
                type: document.getElementById('activityType').value,
                title: document.getElementById('activityTitle').value.trim(),
                description: document.getElementById('activityDescription').value.trim(),
                date: document.getElementById('activityDate').value,
                time: document.getElementById('activityTime').value,
                targetTeacher: document.getElementById('targetTeacher').value,
                priority: document.getElementById('activityPriority').value,
                location: document.getElementById('eventLocation')?.value?.trim() || '',
                createdBy: 'Administrator',
                createdAt: new Date().toISOString(),
                status: 'active'
            };
            
            // Save to localStorage
            const activitiesKey = 'admin_activities';
            const existingActivities = JSON.parse(localStorage.getItem(activitiesKey) || '[]');
            existingActivities.push(activityData);
            localStorage.setItem(activitiesKey, JSON.stringify(existingActivities));
            
            // Get type emoji and priority emoji
            const typeEmojis = {
                'announcement': '',
                'event': '',
                'reminder': '',
                'maintenance': '',
                'update': ''
            };
            
            const priorityEmojis = {
                'low': '',
                'medium': '',
                'high': '',
                'urgent': ''
            };
            
            const typeEmoji = typeEmojis[activityData.type] || '';
            const priorityEmoji = priorityEmojis[activityData.priority] || '';
            
            // Show success message
            alert(` AKTIVITAS BERHASIL DIBUAT!\n\n${typeEmoji} Detail Aktivitas:\n Judul: ${activityData.title}\n Jenis: ${activityData.type.charAt(0).toUpperCase() + activityData.type.slice(1)}\n Tanggal: ${new Date(activityData.date).toLocaleDateString('id-ID')}\n Waktu: ${activityData.time}\n Prioritas: ${priorityEmoji} ${activityData.priority.charAt(0).toUpperCase() + activityData.priority.slice(1)}\n Target: ${activityData.targetTeacher || 'Semua Guru'}\n${activityData.location ? ` Lokasi: ${activityData.location}` : ''}\n\n Deskripsi:\n${activityData.description}\n\n Aktivitas akan muncul di dashboard guru dan sistem notifikasi.`);
            
            // Close modal and refresh
            closeAddActivityModal();
            loadAdminRecentActivity();
        }
        
        function closeAddActivityModal() {
            const modal = document.getElementById('addActivityModal');
            if (modal) {
                modal.remove();
            }
        }

        function editAdminActivity(activityId) {
            if (!activityId) {
                alert('ID aktivitas tidak valid');
                return;
            }
            
            // Get activity data
            const adminActivities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
            const activity = adminActivities.find(a => a.id === activityId);
            
            if (!activity) {
                alert('Aktivitas tidak ditemukan');
                return;
            }
            
            // Create edit activity modal
            const modal = document.createElement('div');
            modal.id = 'editActivityModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Get all teachers for selection
            const teacherOptions = Object.values(teachers).map(teacher => 
                `<option value="${teacher.name}" ${activity.targetTeacher === teacher.name ? 'selected' : ''}>${teacher.name}</option>`
            ).join('');
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800"> Edit Aktivitas</h3>
                            <p class="text-gray-600 text-sm">Perbarui informasi aktivitas</p>
                        </div>
                        <button onclick="closeEditActivityModal()" 
                                class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="updateActivity(event, ${activityId})" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Aktivitas</label>
                            <select id="editActivityType" onchange="updateEditActivityForm()" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <option value="">-- Pilih Jenis Aktivitas --</option>
                                <option value="announcement" ${activity.type === 'announcement' ? 'selected' : ''}> Pengumuman</option>
                                <option value="event" ${activity.type === 'event' ? 'selected' : ''}> Acara/Event</option>
                                <option value="reminder" ${activity.type === 'reminder' ? 'selected' : ''}> Pengingat</option>
                                <option value="maintenance" ${activity.type === 'maintenance' ? 'selected' : ''}> Maintenance Sistem</option>
                                <option value="update" ${activity.type === 'update' ? 'selected' : ''}> Update Sistem</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Judul Aktivitas</label>
                            <input type="text" id="editActivityTitle" value="${activity.title}" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea id="editActivityDescription" rows="4" required
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">${activity.description}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="editActivityDate" value="${activity.date}" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Waktu</label>
                                <input type="time" id="editActivityTime" value="${activity.time}" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Guru (Opsional)</label>
                            <select id="editTargetTeacher" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <option value="" ${!activity.targetTeacher ? 'selected' : ''}>-- Semua Guru --</option>
                                ${teacherOptions}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioritas</label>
                            <select id="editActivityPriority" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <option value="low" ${activity.priority === 'low' ? 'selected' : ''}> Rendah</option>
                                <option value="medium" ${activity.priority === 'medium' ? 'selected' : ''}> Sedang</option>
                                <option value="high" ${activity.priority === 'high' ? 'selected' : ''}> Tinggi</option>
                                <option value="urgent" ${activity.priority === 'urgent' ? 'selected' : ''}> Mendesak</option>
                            </select>
                        </div>
                        
                        <div id="editEventSpecificFields" class="${activity.type === 'event' ? '' : 'hidden'} space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi (untuk Event)</label>
                                <input type="text" id="editEventLocation" value="${activity.location || ''}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-orange-800 mb-2"> Informasi Edit:</h4>
                            <ul class="text-orange-700 text-sm space-y-1">
                                <li> Perubahan akan langsung terlihat di semua dashboard</li>
                                <li> Waktu pembuatan asli tetap tersimpan</li>
                                <li> Riwayat edit akan dicatat dalam sistem</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" 
                                    class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Simpan Perubahan
                            </button>
                            <button type="button" onclick="closeEditActivityModal()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function updateEditActivityForm() {
            const activityType = document.getElementById('editActivityType').value;
            const eventFields = document.getElementById('editEventSpecificFields');
            
            if (activityType === 'event') {
                eventFields.classList.remove('hidden');
                document.getElementById('editEventLocation').required = true;
            } else {
                eventFields.classList.add('hidden');
                document.getElementById('editEventLocation').required = false;
            }
        }
        
        function updateActivity(event, activityId) {
            event.preventDefault();
            
            const updatedActivity = {
                id: activityId,
                type: document.getElementById('editActivityType').value,
                title: document.getElementById('editActivityTitle').value.trim(),
                description: document.getElementById('editActivityDescription').value.trim(),
                date: document.getElementById('editActivityDate').value,
                time: document.getElementById('editActivityTime').value,
                targetTeacher: document.getElementById('editTargetTeacher').value,
                priority: document.getElementById('editActivityPriority').value,
                location: document.getElementById('editEventLocation')?.value?.trim() || '',
                createdBy: 'Administrator',
                createdAt: new Date().toISOString(), // Keep original creation time
                status: 'active',
                lastModified: new Date().toISOString()
            };
            
            // Update in localStorage
            const activitiesKey = 'admin_activities';
            const existingActivities = JSON.parse(localStorage.getItem(activitiesKey) || '[]');
            const activityIndex = existingActivities.findIndex(a => a.id === activityId);
            
            if (activityIndex === -1) {
                alert('Aktivitas tidak ditemukan');
                return;
            }
            
            // Keep original creation time
            updatedActivity.createdAt = existingActivities[activityIndex].createdAt;
            existingActivities[activityIndex] = updatedActivity;
            localStorage.setItem(activitiesKey, JSON.stringify(existingActivities));
            
            // Get type emoji and priority emoji
            const typeEmojis = {
                'announcement': '',
                'event': '',
                'reminder': '',
                'maintenance': '',
                'update': ''
            };
            
            const priorityEmojis = {
                'low': '',
                'medium': '',
                'high': '',
                'urgent': ''
            };
            
            const typeEmoji = typeEmojis[updatedActivity.type] || '';
            const priorityEmoji = priorityEmojis[updatedActivity.priority] || '';
            
            // Show success message
            alert(` AKTIVITAS BERHASIL DIPERBARUI!\n\n${typeEmoji} Detail Aktivitas:\n Judul: ${updatedActivity.title}\n Jenis: ${updatedActivity.type.charAt(0).toUpperCase() + updatedActivity.type.slice(1)}\n Tanggal: ${new Date(updatedActivity.date).toLocaleDateString('id-ID')}\n Waktu: ${updatedActivity.time}\n Prioritas: ${priorityEmoji} ${updatedActivity.priority.charAt(0).toUpperCase() + updatedActivity.priority.slice(1)}\n Target: ${updatedActivity.targetTeacher || 'Semua Guru'}\n${updatedActivity.location ? ` Lokasi: ${updatedActivity.location}` : ''}\n\n Deskripsi:\n${updatedActivity.description}\n\n Perubahan telah disimpan dan akan terlihat di semua dashboard.`);
            
            // Close modal and refresh
            closeEditActivityModal();
            loadAdminRecentActivity();
        }
        
        function closeEditActivityModal() {
            const modal = document.getElementById('editActivityModal');
            if (modal) {
                modal.remove();
            }
        }

        function deleteAdminActivity(activityId) {
            if (!activityId) {
                alert('ID aktivitas tidak valid');
                return;
            }
            
            // Get activity data
            const adminActivities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
            const activity = adminActivities.find(a => a.id === activityId);
            
            if (!activity) {
                alert('Aktivitas tidak ditemukan');
                return;
            }
            
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'deleteActivityModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Get type emoji
            const typeEmojis = {
                'announcement': '',
                'event': '',
                'reminder': '',
                'maintenance': '',
                'update': ''
            };
            const typeEmoji = typeEmojis[activity.type] || '';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Konfirmasi Hapus Aktivitas</h3>
                        <p class="text-gray-600 text-sm mb-4">Tindakan ini tidak dapat dibatalkan!</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-lg">${typeEmoji}</span>
                            <h4 class="font-semibold text-gray-800">${activity.title}</h4>
                        </div>
                        <div class="space-y-1 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Jenis:</span>
                                <span class="font-medium">${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Prioritas:</span>
                                <span class="font-medium">${activity.priority.charAt(0).toUpperCase() + activity.priority.slice(1)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Target:</span>
                                <span class="font-medium">${activity.targetTeacher || 'Semua Guru'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tanggal:</span>
                                <span class="font-medium">${new Date(activity.date).toLocaleDateString('id-ID')}</span>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <p class="text-xs text-gray-600">${activity.description.length > 100 ? activity.description.substring(0, 100) + '...' : activity.description}</p>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-6">
                        <p class="text-red-800 text-sm font-medium mb-2"> Yang akan dihapus:</p>
                        <ul class="text-red-700 text-xs space-y-1">
                            <li> Aktivitas akan hilang dari semua dashboard</li>
                            <li> Guru tidak akan melihat aktivitas ini lagi</li>
                            <li> Data tidak dapat dikembalikan</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ketik <strong>"HAPUS"</strong> untuk konfirmasi:
                        </label>
                        <input type="text" id="deleteActivityConfirmInput" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               placeholder="Ketik HAPUS">
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="confirmDeleteActivity(${activityId})" id="confirmDeleteActivityBtn"
                                class="flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Hapus Aktivitas
                        </button>
                        <button onclick="closeDeleteActivityModal()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add input validation
            const input = document.getElementById('deleteActivityConfirmInput');
            const confirmBtn = document.getElementById('confirmDeleteActivityBtn');
            
            input.addEventListener('input', function() {
                if (this.value.trim().toUpperCase() === 'HAPUS') {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                }
            });
            
            // Initially disable confirm button
            confirmBtn.disabled = true;
        }
        
        function confirmDeleteActivity(activityId) {
            const input = document.getElementById('deleteActivityConfirmInput');
            if (input.value.trim().toUpperCase() !== 'HAPUS') {
                alert('Ketik "HAPUS" untuk konfirmasi');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmDeleteActivityBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `
                <svg class="w-4 h-4 animate-spin inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Menghapus...
            `;
            
            // Simulate processing time
            setTimeout(() => {
                try {
                    // Get activity data before deletion
                    const adminActivities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
                    const activity = adminActivities.find(a => a.id === activityId);
                    
                    if (!activity) {
                        alert('Aktivitas tidak ditemukan');
                        closeDeleteActivityModal();
                        return;
                    }
                    
                    // Remove from localStorage
                    const filteredActivities = adminActivities.filter(a => a.id !== activityId);
                    localStorage.setItem('admin_activities', JSON.stringify(filteredActivities));
                    
                    // Close modal
                    closeDeleteActivityModal();
                    
                    // Show success message
                    alert(` AKTIVITAS BERHASIL DIHAPUS!\n\n Yang telah dihapus:\n Judul: ${activity.title}\n Jenis: ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)}\n Target: ${activity.targetTeacher || 'Semua Guru'}\n\n Aktivitas telah dihapus dari semua dashboard guru.`);
                    
                    // Refresh activity list
                    loadAdminRecentActivity();
                    
                } catch (error) {
                    alert(' Terjadi kesalahan saat menghapus aktivitas. Silakan coba lagi.');
                    console.error('Error deleting activity:', error);
                    closeDeleteActivityModal();
                }
            }, 1500);
        }
        
        function closeDeleteActivityModal() {
            const modal = document.getElementById('deleteActivityModal');
            if (modal) {
                modal.remove();
            }
        }

        // Dashboard functions
        function updateDashboardStats() {
            if (!currentUser) return;
            
            const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
            const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
            
            document.getElementById('totalAttendance').textContent = attendanceHistory.length;
            document.getElementById('activeClasses').textContent = currentUser.classes.length;
            document.getElementById('totalSubjects').textContent = currentUser.subjects.length;
            
            let totalStudents = 0;
            currentUser.classes.forEach(className => {
                const classData = studentsData[className];
                if (classData) {
                    const students = Array.isArray(classData) ? classData : classData.students;
                    totalStudents += students.length;
                }
            });
            document.getElementById('totalStudents').textContent = totalStudents;
            
            // Update recent activity - combine admin activities and teacher attendance
            const recentActivity = document.getElementById('recentActivity');
            const activities = [];
            
            // Load admin activities
            const adminActivities = JSON.parse(localStorage.getItem('admin_activities') || '[]');
            adminActivities.forEach(activity => {
                // Show activity if it's for all teachers or specifically for this teacher
                if (!activity.targetTeacher || activity.targetTeacher === currentUser.name) {
                    activities.push({
                        type: 'admin_activity',
                        activityType: activity.type,
                        title: activity.title,
                        description: activity.description,
                        priority: activity.priority,
                        targetTeacher: activity.targetTeacher,
                        location: activity.location,
                        date: new Date(activity.createdAt),
                        time: new Date(activity.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                        createdBy: activity.createdBy
                    });
                }
            });
            
            // Load teacher's attendance activities
            attendanceHistory.forEach(record => {
                activities.push({
                    type: 'attendance',
                    subject: record.subject,
                    class: record.class,
                    date: new Date(record.date),
                    time: record.time
                });
            });
            
            // Sort by date (newest first)
            activities.sort((a, b) => b.date - a.date);
            
            // Show last 5 activities
            const recentActivities = activities.slice(0, 5);
            
            if (recentActivities.length === 0) {
                recentActivity.innerHTML = '<p class="text-gray-500 text-sm">Belum ada aktivitas</p>';
                return;
            }
            
            recentActivity.innerHTML = recentActivities.map(activity => {
                if (activity.type === 'admin_activity') {
                    // Get type and priority emojis
                    const typeEmojis = {
                        'announcement': '',
                        'event': '',
                        'reminder': '',
                        'maintenance': '',
                        'update': ''
                    };
                    
                    const priorityColors = {
                        'low': 'bg-green-100 text-green-800',
                        'medium': 'bg-yellow-100 text-yellow-800',
                        'high': 'bg-orange-100 text-orange-800',
                        'urgent': 'bg-red-100 text-red-800'
                    };
                    
                    const typeEmoji = typeEmojis[activity.activityType] || '';
                    const priorityColor = priorityColors[activity.priority] || 'bg-gray-100 text-gray-800';
                    
                    return `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-start gap-2 mb-1">
                                <span class="text-sm">${typeEmoji}</span>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="text-sm font-medium text-gray-800 truncate">
                                            ${activity.title}
                                        </p>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColor} flex-shrink-0">
                                            ${activity.priority.charAt(0).toUpperCase() + activity.priority.slice(1)}
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1 line-clamp-2">
                                        ${activity.description.length > 50 ? activity.description.substring(0, 50) + '...' : activity.description}
                                    </p>
                                    <div class="flex items-center justify-between text-xs text-gray-500">
                                        <span>Admin</span>
                                        <span>${activity.date.toLocaleDateString('id-ID')} ${activity.time}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Regular attendance activity
                    return `
                        <div class="text-sm text-gray-600 p-2 bg-gray-50 rounded">
                            <span class="font-medium">${activity.subject}</span> - ${activity.class}
                            <br><span class="text-xs text-gray-500">${activity.date.toLocaleDateString('id-ID')} ${activity.time}</span>
                        </div>
                    `;
                }
            }).join('');
        }

        // Attendance functions
        function updateClassOptions() {
            const subject = document.getElementById('subjectSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            
            if (subject && currentUser) {
                currentUser.classes.forEach(className => {
                    const classData = studentsData[className];
                    if (classData) {
                        // Check if this class has the selected subject
                        const subjects = Array.isArray(classData) ? currentUser.subjects : classData.subjects;
                        if (subjects.includes(subject)) {
                            const option = document.createElement('option');
                            option.value = className;
                            option.textContent = className;
                            classSelect.appendChild(option);
                        }
                    }
                });
            }
            
            checkCanStart();
        }

        function checkCanStart() {
            const subject = document.getElementById('subjectSelect').value;
            const className = document.getElementById('classSelect').value;
            const startBtn = document.getElementById('startAttendanceBtn');
            
            startBtn.disabled = !(subject && className);
        }

        function startAttendance() {
            const subject = document.getElementById('subjectSelect').value;
            const className = document.getElementById('classSelect').value;
            
            if (!subject || !className) return;
            
            document.getElementById('classSelection').classList.add('hidden');
            document.getElementById('attendanceForm').classList.remove('hidden');
            
            document.getElementById('attendanceTitle').textContent = `Absensi ${className}`;
            document.getElementById('attendanceInfo').textContent = 
                `${subject} | ${new Date().toLocaleDateString('id-ID', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                })}`;
            
            loadStudentList(className);
        }

        function loadStudentList(className) {
            const classData = studentsData[className];
            const students = Array.isArray(classData) ? classData : classData.students;
            const tbody = document.getElementById('studentList');
            tbody.innerHTML = '';
            
            currentAttendanceData = {};
            
            students.forEach((student, index) => {
                currentAttendanceData[student] = null;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3 text-center">${index + 1}</td>
                    <td class="border border-gray-300 px-4 py-3 font-medium">${student}</td>
                    <td class="border border-gray-300 px-4 py-3">
                        <div class="flex gap-2 justify-center flex-wrap">
                            ${['hadir', 'alpa', 'sakit', 'izin'].map(status => `
                                <button onclick="setAttendanceStatus('${student}', '${status}')" 
                                        class="attendance-btn-${student.replace(/\s+/g, '')} px-3 py-1 rounded text-sm font-medium transition-all duration-200 border-2 border-gray-300 bg-white text-gray-700 hover:bg-gray-50"
                                        data-status="${status}">
                                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                                </button>
                            `).join('')}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateAttendanceStats();
        }

        function setAttendanceStatus(student, status) {
            currentAttendanceData[student] = status;
            
            const buttons = document.querySelectorAll(`.attendance-btn-${student.replace(/\s+/g, '')}`);
            buttons.forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-blue-500', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700');
                
                if (btn.dataset.status === status) {
                    btn.classList.remove('bg-white', 'text-gray-700');
                    btn.classList.add('text-white');
                    const colors = {
                        'hadir': 'bg-green-500',
                        'alpa': 'bg-red-500',
                        'sakit': 'bg-yellow-500',
                        'izin': 'bg-blue-500'
                    };
                    btn.classList.add(colors[status]);
                }
            });
            
            updateAttendanceStats();
        }

        function updateAttendanceStats() {
            const stats = { hadir: 0, alpa: 0, sakit: 0, izin: 0 };
            Object.values(currentAttendanceData).forEach(status => {
                if (status && stats[status] !== undefined) {
                    stats[status]++;
                }
            });
            
            document.getElementById('attendanceStats').textContent = 
                `Hadir: ${stats.hadir} | Alpa: ${stats.alpa} | Sakit: ${stats.sakit} | Izin: ${stats.izin}`;
        }

        function backToSelection() {
            document.getElementById('attendanceForm').classList.add('hidden');
            document.getElementById('classSelection').classList.remove('hidden');
        }

        function saveAttendance() {
            const subject = document.getElementById('subjectSelect').value;
            const className = document.getElementById('classSelect').value;
            
            if (!subject || !className || !currentUser) return;
            
            const attendanceRecord = {
                id: Date.now(),
                teacher: currentUser.name,
                subject: subject,
                class: className,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('id-ID'),
                attendance: { ...currentAttendanceData }
            };
            
            const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
            const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
            attendanceHistory.push(attendanceRecord);
            localStorage.setItem(attendanceKey, JSON.stringify(attendanceHistory));
            
            alert('Absensi berhasil disimpan!');
            
            // Reset form
            document.getElementById('subjectSelect').value = '';
            document.getElementById('classSelect').value = '';
            checkCanStart();
            
            showRecap();
        }

        // Recap functions
        function loadRecapData() {
            if (!currentUser) return;
            
            const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
            const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
            
            const tbody = document.getElementById('recapTableBody');
            const noDataDiv = document.getElementById('noRecapData');
            
            if (attendanceHistory.length === 0) {
                tbody.innerHTML = '';
                noDataDiv.classList.remove('hidden');
                return;
            }
            
            noDataDiv.classList.add('hidden');
            tbody.innerHTML = '';
            
            attendanceHistory.forEach((record, index) => {
                const stats = { hadir: 0, alpa: 0, sakit: 0, izin: 0 };
                Object.values(record.attendance).forEach(status => {
                    if (status && stats[status] !== undefined) {
                        stats[status]++;
                    }
                });
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3 text-center">${index + 1}</td>
                    <td class="border border-gray-300 px-4 py-3">${new Date(record.date).toLocaleDateString('id-ID')}</td>
                    <td class="border border-gray-300 px-4 py-3">${record.subject}</td>
                    <td class="border border-gray-300 px-4 py-3">${record.class}</td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">${stats.hadir}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">${stats.alpa}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">${stats.sakit}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${stats.izin}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <button onclick="viewAttendanceDetail(${record.id})" 
                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm">
                            Detail
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewAttendanceDetail(recordId) {
            const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
            const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
            const record = attendanceHistory.find(r => r.id === recordId);
            
            if (!record) return;
            
            currentDetailData = record;
            
            const students = studentsData[record.class];
            const stats = { hadir: 0, alpa: 0, sakit: 0, izin: 0 };
            
            Object.values(record.attendance).forEach(status => {
                if (status && stats[status] !== undefined) {
                    stats[status]++;
                }
            });
            
            const content = document.getElementById('attendanceDetailContent');
            content.innerHTML = `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">${record.subject} - ${record.class}</h4>
                    <p class="text-gray-600">${new Date(record.date).toLocaleDateString('id-ID')} | ${record.time}</p>
                </div>
                
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${stats.hadir}</div>
                        <div class="text-sm text-green-800">Hadir</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${stats.alpa}</div>
                        <div class="text-sm text-red-800">Alpa</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600">${stats.sakit}</div>
                        <div class="text-sm text-yellow-800">Sakit</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${stats.izin}</div>
                        <div class="text-sm text-blue-800">Izin</div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-4 py-3 text-left">No</th>
                                <th class="border border-gray-300 px-4 py-3 text-left">Nama Siswa</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map((student, index) => {
                                const status = record.attendance[student] || 'Tidak tercatat';
                                const statusColors = {
                                    'hadir': 'bg-green-100 text-green-800',
                                    'alpa': 'bg-red-100 text-red-800',
                                    'sakit': 'bg-yellow-100 text-yellow-800',
                                    'izin': 'bg-blue-100 text-blue-800'
                                };
                                const colorClass = statusColors[status] || 'bg-gray-100 text-gray-800';
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="border border-gray-300 px-4 py-3 text-center">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-3">${student}</td>
                                        <td class="border border-gray-300 px-4 py-3 text-center">
                                            <span class="px-3 py-1 rounded-full text-sm font-medium ${colorClass}">
                                                ${status.charAt(0).toUpperCase() + status.slice(1)}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('attendanceDetailModal').classList.remove('hidden');
            document.getElementById('attendanceDetailModal').classList.add('flex');
        }

        function closeAttendanceDetailModal() {
            document.getElementById('attendanceDetailModal').classList.add('hidden');
            document.getElementById('attendanceDetailModal').classList.remove('flex');
            currentDetailData = null;
        }



        // Grades functions
        function loadGradesOptions() {
            if (!currentUser) return;
            
            const subjectSelect = document.getElementById('gradesSubjectSelect');
            const classSelect = document.getElementById('gradesClassSelect');
            
            subjectSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
            classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            
            currentUser.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            
            // Add event listener to filter classes based on selected subject
            subjectSelect.addEventListener('change', function() {
                const selectedSubject = this.value;
                classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                
                if (selectedSubject) {
                    currentUser.classes.forEach(className => {
                        const classData = studentsData[className];
                        if (classData) {
                            const subjects = Array.isArray(classData) ? currentUser.subjects : classData.subjects;
                            if (subjects.includes(selectedSubject)) {
                                const option = document.createElement('option');
                                option.value = className;
                                option.textContent = className;
                                classSelect.appendChild(option);
                            }
                        }
                    });
                }
            });
        }

        function loadGradesData() {
            const subject = document.getElementById('gradesSubjectSelect').value;
            const className = document.getElementById('gradesClassSelect').value;
            
            if (!subject || !className || !currentUser) {
                document.getElementById('gradesTableContainer').classList.add('hidden');
                document.getElementById('noGradesData').classList.remove('hidden');
                return;
            }
            
            document.getElementById('noGradesData').classList.add('hidden');
            document.getElementById('gradesTableContainer').classList.remove('hidden');
            
            const gradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
            let gradesData = JSON.parse(localStorage.getItem(gradesKey) || '{}');
            
            const classData = studentsData[className];
            const students = Array.isArray(classData) ? classData : classData.students;
            const tbody = document.getElementById('gradesTableBody');
            tbody.innerHTML = '';
            
            students.forEach((student, index) => {
                if (!gradesData[student]) {
                    gradesData[student] = {
                        tp1: '', tp2: '', tp3: '', formatif1: '',
                        tp4: '', tp5: '', tp6: '', formatif2: '',
                        tp7: '', tp8: '', tp9: '', formatif3: '',
                        psat: '', psaf: ''
                    };
                }
                
                const grades = gradesData[student];
                const disabled = !isEditMode ? 'disabled' : '';
                const bgClass = !isEditMode ? 'bg-gray-100' : 'bg-white';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-2 py-3 text-center sticky-col">${index + 1}</td>
                    <td class="border border-gray-300 px-3 py-3 font-medium sticky-col-2">${student}</td>
                    ${['tp1', 'tp2', 'tp3'].map(field => `
                        <td class="border border-gray-300 px-2 py-3 text-center">
                            <input type="number" min="0" max="100" value="${grades[field]}" 
                                   onchange="updateGrade('${student}', '${field}', this.value)"
                                   class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input ${bgClass}" ${disabled}>
                        </td>
                    `).join('')}
                    <td class="border border-gray-300 px-2 py-3 text-center bg-blue-100">
                        <input type="number" min="0" max="100" value="${grades.formatif1}" 
                               onchange="updateGrade('${student}', 'formatif1', this.value)"
                               class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input bg-blue-100" ${disabled}>
                    </td>
                    ${['tp4', 'tp5', 'tp6'].map(field => `
                        <td class="border border-gray-300 px-2 py-3 text-center">
                            <input type="number" min="0" max="100" value="${grades[field]}" 
                                   onchange="updateGrade('${student}', '${field}', this.value)"
                                   class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input ${bgClass}" ${disabled}>
                        </td>
                    `).join('')}
                    <td class="border border-gray-300 px-2 py-3 text-center bg-blue-100">
                        <input type="number" min="0" max="100" value="${grades.formatif2}" 
                               onchange="updateGrade('${student}', 'formatif2', this.value)"
                               class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input bg-blue-100" ${disabled}>
                    </td>
                    ${['tp7', 'tp8', 'tp9'].map(field => `
                        <td class="border border-gray-300 px-2 py-3 text-center">
                            <input type="number" min="0" max="100" value="${grades[field]}" 
                                   onchange="updateGrade('${student}', '${field}', this.value)"
                                   class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input ${bgClass}" ${disabled}>
                        </td>
                    `).join('')}
                    <td class="border border-gray-300 px-2 py-3 text-center bg-blue-100">
                        <input type="number" min="0" max="100" value="${grades.formatif3}" 
                               onchange="updateGrade('${student}', 'formatif3', this.value)"
                               class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input bg-blue-100" ${disabled}>
                    </td>
                    <td class="border border-gray-300 px-2 py-3 text-center bg-yellow-50">
                        <input type="number" min="0" max="100" value="${grades.psat}" 
                               onchange="updateGrade('${student}', 'psat', this.value)"
                               class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input bg-yellow-50" ${disabled}>
                    </td>
                    <td class="border border-gray-300 px-2 py-3 text-center bg-yellow-50">
                        <input type="number" min="0" max="100" value="${grades.psaf}" 
                               onchange="updateGrade('${student}', 'psaf', this.value)"
                               class="w-full text-center border-0 focus:ring-0 rounded px-1 py-1 grade-input bg-yellow-50" ${disabled}>
                    </td>
                    <td class="border border-gray-300 px-2 py-3 text-center bg-green-100">
                        <span class="font-medium text-green-800" id="avg_${student.replace(/\s+/g, '_')}">${calculateAverage(grades)}</span>
                    </td>
                    <td class="border border-gray-300 px-2 py-3 text-center bg-green-600">
                        <span class="font-bold text-white" id="grade_${student.replace(/\s+/g, '_')}">${calculateFinalGrade(grades)}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            currentGradesData = gradesData;
            localStorage.setItem(gradesKey, JSON.stringify(gradesData));
        }

        function updateGrade(student, field, value) {
            if (!currentGradesData[student]) {
                currentGradesData[student] = {};
            }
            
            currentGradesData[student][field] = value;
            
            // Update calculated fields
            const avg = calculateAverage(currentGradesData[student]);
            const finalGrade = calculateFinalGrade(currentGradesData[student]);
            
            document.getElementById(`avg_${student.replace(/\s+/g, '_')}`).textContent = avg;
            document.getElementById(`grade_${student.replace(/\s+/g, '_')}`).textContent = finalGrade;
        }

        function calculateAverage(grades) {
            const values = Object.values(grades).filter(val => val !== '' && val !== null && val !== undefined);
            if (values.length === 0) return '';
            
            const sum = values.reduce((acc, val) => acc + parseFloat(val), 0);
            return Math.round((sum / values.length) * 100) / 100;
        }

        function calculateFinalGrade(grades) {
            const avg = calculateAverage(grades);
            if (avg === '') return '';
            
            if (avg >= 90) return 'A';
            if (avg >= 80) return 'B';
            if (avg >= 70) return 'C';
            if (avg >= 60) return 'D';
            return 'E';
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            const editBtn = document.getElementById('editGradesBtn');
            const saveBtn = document.getElementById('saveGradesBtn');
            const editBtnText = document.getElementById('editBtnText');
            
            if (isEditMode) {
                editBtnText.textContent = 'Batal';
                editBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                editBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                saveBtn.classList.remove('hidden');
            } else {
                editBtnText.textContent = 'Edit';
                editBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                editBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                saveBtn.classList.add('hidden');
            }
            
            loadGradesData();
        }

        function saveGrades() {
            const subject = document.getElementById('gradesSubjectSelect').value;
            const className = document.getElementById('gradesClassSelect').value;
            
            if (!subject || !className || !currentUser) return;
            
            const gradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
            localStorage.setItem(gradesKey, JSON.stringify(currentGradesData));
            
            alert('Data nilai berhasil disimpan!');
            toggleEditMode();
        }



        // Class Management functions
        function loadClassManagementData() {
            if (!currentUser) return;
            
            const totalClasses = currentUser.classes.length;
            let totalStudents = 0;
            
            currentUser.classes.forEach(className => {
                if (studentsData[className]) {
                    const classData = studentsData[className];
                    const students = Array.isArray(classData) ? classData : classData.students;
                    totalStudents += students.length;
                }
            });
            
            const averageSize = totalClasses > 0 ? Math.round(totalStudents / totalClasses) : 0;
            
            document.getElementById('totalClassesCount').textContent = totalClasses;
            document.getElementById('totalStudentsCount').textContent = totalStudents;
            document.getElementById('averageClassSize').textContent = averageSize;
            
            // Load classes overview
            const overviewList = document.getElementById('classesOverviewList');
            overviewList.innerHTML = '';
            
            if (totalClasses === 0) {
                overviewList.innerHTML = `
                    <div class="text-center py-8 bg-gray-50 rounded-lg">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <p class="text-gray-600 mb-4">Belum ada kelas yang dibuat</p>
                        <button onclick="showCreateClass()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                            Buat Kelas Pertama
                        </button>
                    </div>
                `;
                return;
            }
            
            currentUser.classes.forEach(className => {
                const classData = studentsData[className] || [];
                const students = Array.isArray(classData) ? classData : classData.students;
                const subjects = Array.isArray(classData) ? currentUser.subjects : classData.subjects;
                const classCard = document.createElement('div');
                classCard.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200';
                
                classCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">${className}</h4>
                            <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-2.239"></path>
                                    </svg>
                                    ${students.length} siswa
                                </span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    ${subjects.length} mata pelajaran
                                </span>
                            </div>
                            <div class="text-xs text-gray-500">
                                <strong>Mata Pelajaran:</strong> ${subjects.join(', ')}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editClass('${className}')" 
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit
                            </button>
                            <button onclick="deleteClass('${className}')" 
                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
                
                overviewList.appendChild(classCard);
            });
        }

        function loadEditClassesList() {
            if (!currentUser) return;
            
            const editList = document.getElementById('editClassesList');
            const noClassesDiv = document.getElementById('noEditClasses');
            
            if (currentUser.classes.length === 0) {
                editList.innerHTML = '';
                noClassesDiv.classList.remove('hidden');
                return;
            }
            
            noClassesDiv.classList.add('hidden');
            editList.innerHTML = '';
            
            currentUser.classes.forEach(className => {
                const classData = studentsData[className] || [];
                const students = Array.isArray(classData) ? classData : classData.students;
                const subjects = Array.isArray(classData) ? currentUser.subjects : classData.subjects;
                const classCard = document.createElement('div');
                classCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-6';
                
                classCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-xl font-semibold text-gray-800">${className}</h4>
                            <p class="text-gray-600">${students.length} siswa terdaftar</p>
                            <p class="text-sm text-gray-500">${subjects.length} mata pelajaran: ${subjects.join(', ')}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editClass('${className}')" 
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit Kelas
                            </button>
                            <button onclick="deleteClass('${className}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Hapus Kelas
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4">
                        <h5 class="font-medium text-gray-800 mb-3">Daftar Siswa:</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                            ${students.map((student, index) => `
                                <div class="text-sm text-gray-700 py-1">
                                    <span class="font-medium">${index + 1}.</span> ${student}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                editList.appendChild(classCard);
            });
        }

        function editClass(className) {
            if (!className || !currentUser) {
                alert('Error: Data kelas tidak valid');
                return;
            }
            showEditClassForm(className);
        }

        function showEditClassForm(className) {
            const classData = studentsData[className] || [];
            const students = Array.isArray(classData) ? classData : classData.students;
            
            // Create edit form modal
            const modal = document.createElement('div');
            modal.id = 'editClassModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Edit Kelas: ${className}</h3>
                        <button onclick="closeEditClassModal()" 
                                class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form onsubmit="saveEditedClass(event, '${className}')" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" id="editClassName" value="${className}" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa</label>
                            <input type="number" id="editStudentCount" value="${students.length}" min="1" max="50" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="button" onclick="updateEditStudentInputs()" 
                                    class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                Update Jumlah Siswa
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daftar Siswa</label>
                            <div id="editStudentsList" class="space-y-2 max-h-60 overflow-y-auto">
                                ${students.map((student, index) => `
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm font-medium text-gray-600 w-8">${index + 1}.</span>
                                        <input type="text" name="editStudentName${index + 1}" value="${student}" required
                                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex gap-4 pt-4">
                            <button type="submit" 
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Simpan Perubahan
                            </button>
                            <button type="button" onclick="closeEditClassModal()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function updateEditStudentInputs() {
            const count = parseInt(document.getElementById('editStudentCount').value);
            if (!count || count < 1 || count > 50) {
                alert('Masukkan jumlah siswa yang valid (1-50)');
                return;
            }
            
            const list = document.getElementById('editStudentsList');
            const currentInputs = list.querySelectorAll('input[name^="editStudentName"]');
            const currentValues = Array.from(currentInputs).map(input => input.value);
            
            list.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const inputDiv = document.createElement('div');
                inputDiv.className = 'flex items-center gap-3';
                inputDiv.innerHTML = `
                    <span class="text-sm font-medium text-gray-600 w-8">${i}.</span>
                    <input type="text" name="editStudentName${i}" value="${currentValues[i-1] || ''}" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Nama siswa ${i}">
                `;
                list.appendChild(inputDiv);
            }
        }

        function saveEditedClass(event, originalClassName) {
            event.preventDefault();
            
            const newClassName = document.getElementById('editClassName').value.trim();
            const count = parseInt(document.getElementById('editStudentCount').value);
            
            if (!newClassName || !count) {
                alert('Mohon lengkapi semua field');
                return;
            }
            
            // Check if new class name already exists (and it's different from original)
            if (newClassName !== originalClassName && studentsData[newClassName]) {
                alert('Kelas dengan nama tersebut sudah ada!');
                return;
            }
            
            // Collect student names
            const studentNames = [];
            for (let i = 1; i <= count; i++) {
                const input = document.querySelector(`input[name="editStudentName${i}"]`);
                if (input && input.value.trim()) {
                    studentNames.push(input.value.trim());
                }
            }
            
            if (studentNames.length !== count) {
                alert('Mohon isi semua nama siswa');
                return;
            }
            
            // If class name changed, handle the rename
            if (newClassName !== originalClassName) {
                // Remove old class data
                delete studentsData[originalClassName];
                
                // Update teacher's class list
                const classIndex = currentUser.classes.indexOf(originalClassName);
                if (classIndex > -1) {
                    currentUser.classes[classIndex] = newClassName;
                }
                
                // Update teacher data in storage
                const teacherKey = Object.keys(teachers).find(key => teachers[key].name === currentUser.name);
                if (teacherKey) {
                    teachers[teacherKey].classes = [...currentUser.classes];
                    localStorage.setItem('teachersData', JSON.stringify(teachers));
                }
                
                // Move attendance data
                const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
                const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
                attendanceHistory.forEach(record => {
                    if (record.class === originalClassName) {
                        record.class = newClassName;
                    }
                });
                localStorage.setItem(attendanceKey, JSON.stringify(attendanceHistory));
                
                // Move grades data
                currentUser.subjects.forEach(subject => {
                    const oldGradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${originalClassName.replace(/\s+/g, '_')}`;
                    const newGradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${newClassName.replace(/\s+/g, '_')}`;
                    
                    const gradesData = localStorage.getItem(oldGradesKey);
                    if (gradesData) {
                        localStorage.setItem(newGradesKey, gradesData);
                        localStorage.removeItem(oldGradesKey);
                    }
                });
            }
            
            // Update students data
            studentsData[newClassName] = studentNames;
            
            // Update grades data structure for new/removed students
            currentUser.subjects.forEach(subject => {
                const gradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${newClassName.replace(/\s+/g, '_')}`;
                let gradesData = JSON.parse(localStorage.getItem(gradesKey) || '{}');
                
                // Create new grades structure
                const newGradesData = {};
                studentNames.forEach(student => {
                    if (gradesData[student]) {
                        // Keep existing grades
                        newGradesData[student] = gradesData[student];
                    } else {
                        // Create empty grades for new students
                        newGradesData[student] = {
                            tp1: '', tp2: '', tp3: '', formatif1: '',
                            tp4: '', tp5: '', tp6: '', formatif2: '',
                            tp7: '', tp8: '', tp9: '', formatif3: '',
                            psat: '', psaf: ''
                        };
                    }
                });
                
                localStorage.setItem(gradesKey, JSON.stringify(newGradesData));
            });
            
            // Save students data
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            
            alert(` Kelas berhasil diperbarui!\n\n Perubahan:\n Nama: ${newClassName}\n Jumlah siswa: ${count}\n Data nilai dan absensi tetap tersimpan`);
            
            // Close modal and refresh
            closeEditClassModal();
            loadTeacherOptions();
            loadClassManagementData();
            updateDashboardStats();
        }

        function closeEditClassModal() {
            const modal = document.getElementById('editClassModal');
            if (modal) {
                modal.remove();
            }
        }

        // Create Class functions
        function importFromCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file CSV terlebih dahulu');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('File harus berformat CSV');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const studentNames = parseCSV(csvContent);
                    
                    if (studentNames.length === 0) {
                        alert('File CSV kosong atau tidak valid');
                        return;
                    }
                    
                    if (studentNames.length > 50) {
                        alert('Maksimal 50 siswa per kelas');
                        return;
                    }
                    
                    // Update student count
                    document.getElementById('studentCount').value = studentNames.length;
                    
                    // Generate input fields
                    generateStudentInputs();
                    
                    // Fill the inputs with imported names
                    studentNames.forEach((name, index) => {
                        const input = document.querySelector(`input[name="studentName${index + 1}"]`);
                        if (input) {
                            input.value = name.trim();
                        }
                    });
                    
                    alert(`Berhasil import ${studentNames.length} nama siswa dari CSV`);
                    
                } catch (error) {
                    alert('Error membaca file CSV: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error membaca file');
            };
            
            reader.readAsText(file);
        }
        
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n');
            const names = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    // Check if line contains commas (comma-separated)
                    if (line.includes(',')) {
                        const commaSeparated = line.split(',');
                        commaSeparated.forEach(name => {
                            const trimmedName = name.trim().replace(/"/g, '');
                            if (trimmedName) {
                                names.push(trimmedName);
                            }
                        });
                    } else {
                        // Single name per line
                        const trimmedName = line.replace(/"/g, '');
                        if (trimmedName) {
                            names.push(trimmedName);
                        }
                    }
                }
            });
            
            // Remove duplicates and empty names
            return [...new Set(names)].filter(name => name.length > 0);
        }

        function loadExistingClasses() {
            if (!currentUser) return;
            
            const existingList = document.getElementById('existingClassesList');
            existingList.innerHTML = '';
            
            currentUser.classes.forEach(className => {
                const students = studentsData[className];
                const classItem = document.createElement('div');
                classItem.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                classItem.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-800">${className}</span>
                        <span class="text-sm text-gray-600 ml-2">(${students.length} siswa)</span>
                    </div>
                    <button onclick="deleteClass('${className}')" 
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                        Hapus
                    </button>
                `;
                existingList.appendChild(classItem);
            });
            
            if (currentUser.classes.length === 0) {
                existingList.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada kelas yang dibuat</p>';
            }
        }

        function generateStudentInputs() {
            const count = parseInt(document.getElementById('studentCount').value);
            if (!count || count < 1 || count > 50) {
                alert('Masukkan jumlah siswa yang valid (1-50)');
                return;
            }
            
            const container = document.getElementById('studentNamesContainer');
            const list = document.getElementById('studentNamesList');
            
            list.innerHTML = '';
            
            for (let i = 1; i <= count; i++) {
                const inputDiv = document.createElement('div');
                inputDiv.className = 'flex items-center gap-3';
                inputDiv.innerHTML = `
                    <span class="text-sm font-medium text-gray-600 w-8">${i}.</span>
                    <input type="text" name="studentName${i}" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Nama siswa ${i}">
                `;
                list.appendChild(inputDiv);
            }
            
            container.classList.remove('hidden');
        }

        function createNewClass(event) {
            event.preventDefault();
            
            const className = document.getElementById('newClassName').value.trim();
            const count = parseInt(document.getElementById('studentCount').value);
            
            if (!className || !count) {
                alert('Mohon lengkapi semua field');
                return;
            }
            
            // Use selected subjects from checkboxes
            const selectedSubjects = [...selectedSubjectsForClass];
            
            if (selectedSubjects.length === 0) {
                alert('Pilih minimal satu mata pelajaran untuk kelas ini!');
                return;
            }
            
            // Check if class already exists globally
            if (studentsData[className]) {
                alert('Kelas dengan nama tersebut sudah ada!');
                return;
            }
            
            // Collect student names
            const studentNames = [];
            for (let i = 1; i <= count; i++) {
                const input = document.querySelector(`input[name="studentName${i}"]`);
                if (input && input.value.trim()) {
                    studentNames.push(input.value.trim());
                }
            }
            
            if (studentNames.length !== count) {
                alert('Mohon isi semua nama siswa');
                return;
            }
            
            // Add to global studentsData with subject information
            studentsData[className] = {
                students: studentNames,
                subjects: selectedSubjects,
                teacher: currentUser.name
            };
            
            // AUTOMATICALLY add to current user's active classes
            if (!currentUser.classes.includes(className)) {
                currentUser.classes.push(className);
                
                // Update teacher data in both memory and localStorage
                const teacherKey = Object.keys(teachers).find(key => teachers[key].name === currentUser.name);
                if (teacherKey) {
                    teachers[teacherKey].classes = [...currentUser.classes];
                    localStorage.setItem('teachersData', JSON.stringify(teachers));
                }
            }
            
            // Initialize empty grades data for selected subjects only
            selectedSubjects.forEach(subject => {
                const gradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                const initialGradesData = {};
                
                // Create empty grade structure for each student
                studentNames.forEach(student => {
                    initialGradesData[student] = {
                        tp1: '', tp2: '', tp3: '', formatif1: '',
                        tp4: '', tp5: '', tp6: '', formatif2: '',
                        tp7: '', tp8: '', tp9: '', formatif3: '',
                        psat: '', psaf: ''
                    };
                });
                
                localStorage.setItem(gradesKey, JSON.stringify(initialGradesData));
            });
            
            // Save students data to localStorage
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            
            alert(` Kelas "${className}" berhasil dibuat!\n\n Detail:\n ${count} siswa terdaftar\n ${selectedSubjects.length} mata pelajaran: ${selectedSubjects.join(', ')}\n Otomatis menggunakan semua mata pelajaran Anda\n Siap untuk absensi dan penilaian\n\n Kelas sekarang tersedia di:\n Menu Absensi (semua mata pelajaran Anda)\n Menu Nilai Siswa (semua mata pelajaran Anda)\n Dashboard (Kelas Aktif)\n\n Kembali ke halaman Kelola Kelas untuk melihat kelas baru Anda.`);
            
            // Reset form
            document.getElementById('newClassName').value = '';
            document.getElementById('studentCount').value = '';
            document.getElementById('studentNamesContainer').classList.add('hidden');
            document.getElementById('csvFileInput').value = '';
            
            // Reset subject selection
            selectedSubjectsForClass = [];
            const checkboxes = document.querySelectorAll('#subjectCheckboxList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            document.getElementById('selectAllSubjects').checked = false;
            document.getElementById('selectAllSubjects').indeterminate = false;
            updateSelectedSubjectsDisplay();
            document.getElementById('subjectDropdown').classList.add('hidden');
            
            // Reload all relevant data and options
            loadTeacherOptions();
            loadClassManagementData();
            updateDashboardStats();
            
            // Automatically go back to class management to show the new class
            showClassManagement();
        }

        function deleteClass(className) {
            if (!className || !currentUser) {
                alert('Error: Data kelas tidak valid');
                return;
            }
            
            // Show detailed confirmation dialog
            const students = studentsData[className] || [];
            const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
            const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
            const attendanceCount = attendanceHistory.filter(record => record.class === className).length;
            
            let hasGrades = false;
            currentUser.subjects.forEach(subject => {
                const gradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                const gradesData = JSON.parse(localStorage.getItem(gradesKey) || '{}');
                if (Object.keys(gradesData).length > 0) {
                    hasGrades = true;
                }
            });
            
            // Create custom confirmation modal
            const modal = document.createElement('div');
            modal.id = 'deleteConfirmModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Konfirmasi Hapus Kelas</h3>
                        <p class="text-gray-600 text-sm mb-4">Tindakan ini tidak dapat dibatalkan!</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-gray-800 mb-2">${className}</h4>
                        <div class="space-y-1 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Jumlah siswa:</span>
                                <span class="font-medium">${students.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Data absensi:</span>
                                <span class="font-medium">${attendanceCount} record</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Data nilai:</span>
                                <span class="font-medium">${hasGrades ? 'Ada' : 'Tidak ada'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-6">
                        <p class="text-red-800 text-sm font-medium mb-2"> Yang akan dihapus:</p>
                        <ul class="text-red-700 text-xs space-y-1">
                            <li> Semua data siswa</li>
                            <li> Riwayat absensi</li>
                            <li> Data nilai semua mata pelajaran</li>
                            <li> Tidak dapat dikembalikan!</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ketik <strong>"HAPUS"</strong> untuk konfirmasi:
                        </label>
                        <input type="text" id="deleteConfirmInput" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               placeholder="Ketik HAPUS">
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="confirmDeleteClass('${className}')" id="confirmDeleteBtn"
                                class="flex-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Hapus Kelas
                        </button>
                        <button onclick="closeDeleteModal()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add input validation
            const input = document.getElementById('deleteConfirmInput');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            input.addEventListener('input', function() {
                if (this.value.trim().toUpperCase() === 'HAPUS') {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                }
            });
            
            // Initially disable confirm button
            confirmBtn.disabled = true;
        }
        
        function confirmDeleteClass(className) {
            const input = document.getElementById('deleteConfirmInput');
            if (input.value.trim().toUpperCase() !== 'HAPUS') {
                alert('Ketik "HAPUS" untuk konfirmasi');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `
                <svg class="w-4 h-4 animate-spin inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Menghapus...
            `;
            
            // Simulate processing time
            setTimeout(() => {
                try {
                    const students = studentsData[className] || [];
                    const attendanceKey = `attendance_${currentUser.name.replace(/\s+/g, '_')}`;
                    const attendanceHistory = JSON.parse(localStorage.getItem(attendanceKey) || '[]');
                    const attendanceCount = attendanceHistory.filter(record => record.class === className).length;
                    
                    // Remove from studentsData
                    delete studentsData[className];
                    
                    // Remove from current user's classes
                    const index = currentUser.classes.indexOf(className);
                    if (index > -1) {
                        currentUser.classes.splice(index, 1);
                        
                        // Update teacher data
                        const teacherKey = Object.keys(teachers).find(key => teachers[key].name === currentUser.name);
                        if (teacherKey) {
                            teachers[teacherKey].classes = [...currentUser.classes];
                            localStorage.setItem('teachersData', JSON.stringify(teachers));
                        }
                    }
                    
                    // Remove related attendance data
                    const filteredAttendance = attendanceHistory.filter(record => record.class !== className);
                    localStorage.setItem(attendanceKey, JSON.stringify(filteredAttendance));
                    
                    // Remove grades data for all subjects
                    let removedGradesCount = 0;
                    currentUser.subjects.forEach(subject => {
                        const gradesKey = `grades_${currentUser.name.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                        if (localStorage.getItem(gradesKey)) {
                            localStorage.removeItem(gradesKey);
                            removedGradesCount++;
                        }
                    });
                    
                    // Save updated students data
                    localStorage.setItem('studentsData', JSON.stringify(studentsData));
                    
                    // Close modal
                    closeDeleteModal();
                    
                    // Show success message
                    alert(` KELAS BERHASIL DIHAPUS!\n\n Yang telah dihapus:\n Kelas: ${className}\n ${students.length} data siswa\n ${attendanceCount} record absensi\n ${removedGradesCount} data nilai mata pelajaran\n\n Sistem telah diperbarui secara otomatis.`);
                    
                    // Reload all relevant data
                    loadTeacherOptions();
                    loadClassManagementData();
                    updateDashboardStats();
                    
                    // If currently viewing grades or attendance for this class, reset the view
                    const currentGradesClass = document.getElementById('gradesClassSelect')?.value;
                    const currentAttendanceClass = document.getElementById('classSelect')?.value;
                    
                    if (currentGradesClass === className) {
                        document.getElementById('gradesClassSelect').value = '';
                        document.getElementById('gradesTableContainer').classList.add('hidden');
                        document.getElementById('noGradesData').classList.remove('hidden');
                    }
                    
                    if (currentAttendanceClass === className) {
                        document.getElementById('classSelect').value = '';
                        checkCanStart();
                    }
                    
                } catch (error) {
                    alert(' Terjadi kesalahan saat menghapus kelas. Silakan coba lagi.');
                    console.error('Error deleting class:', error);
                    closeDeleteModal();
                }
            }, 1500);
        }
        
        function closeDeleteModal() {
            const modal = document.getElementById('deleteConfirmModal');
            if (modal) {
                modal.remove();
            }
        }

        // Public grades functions
        function loadPublicTeachers() {
            const select = document.getElementById('publicTeacherSelect');
            select.innerHTML = '<option value="">-- Pilih Guru --</option>';
            
            Object.values(teachers).forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                select.appendChild(option);
            });
        }

        function loadPublicSubjects() {
            const teacherName = document.getElementById('publicTeacherSelect').value;
            const subjectSelect = document.getElementById('publicSubjectSelect');
            
            subjectSelect.innerHTML = '<option value="">-- Pilih Mata Pelajaran --</option>';
            
            if (teacherName) {
                const teacher = Object.values(teachers).find(t => t.name === teacherName);
                if (teacher) {
                    teacher.subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        subjectSelect.appendChild(option);
                    });
                }
            }
            
            document.getElementById('publicClassList').classList.add('hidden');
            document.getElementById('noPublicData').classList.remove('hidden');
        }

        function loadPublicClasses() {
            const teacherName = document.getElementById('publicTeacherSelect').value;
            const subject = document.getElementById('publicSubjectSelect').value;
            
            if (!teacherName || !subject) {
                document.getElementById('publicClassList').classList.add('hidden');
                document.getElementById('noPublicData').classList.remove('hidden');
                return;
            }
            
            const teacher = Object.values(teachers).find(t => t.name === teacherName);
            if (!teacher) return;
            
            const classList = document.getElementById('publicClassList');
            classList.innerHTML = '';
            
            let hasData = false;
            
            teacher.classes.forEach(className => {
                const classData = studentsData[className];
                if (classData) {
                    const subjects = Array.isArray(classData) ? teacher.subjects : classData.subjects;
                    
                    // Only show classes that have the selected subject
                    if (subjects.includes(subject)) {
                        const gradesKey = `grades_${teacherName.replace(/\s+/g, '_')}_${subject.replace(/\s+/g, '_')}_${className.replace(/\s+/g, '_')}`;
                        const gradesData = JSON.parse(localStorage.getItem(gradesKey) || '{}');
                        
                        const hasGrades = Object.keys(gradesData).length > 0 && 
                                         Object.values(gradesData).some(grades => 
                                             Object.values(grades).some(value => value !== '' && value !== null && value !== undefined)
                                         );
                        
                        if (hasGrades) {
                            hasData = true;
                            
                            const students = Array.isArray(classData) ? classData : classData.students;
                            let studentsWithGrades = 0;
                            let totalScore = 0;
                            
                            students.forEach(student => {
                                if (gradesData[student]) {
                                    const avg = calculateAverage(gradesData[student]);
                                    if (avg !== '') {
                                        studentsWithGrades++;
                                        totalScore += parseFloat(avg);
                                    }
                                }
                            });
                            
                            const averageScore = studentsWithGrades > 0 ? Math.round((totalScore / studentsWithGrades) * 100) / 100 : 0;
                            
                            const classCard = document.createElement('div');
                            classCard.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 cursor-pointer';
                            classCard.onclick = () => showPublicGradeDetail(teacherName, subject, className, gradesData);
                            
                            classCard.innerHTML = `
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="text-lg font-semibold text-gray-800">${className}</h4>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${students.length} siswa</span>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Siswa dengan nilai:</span>
                                        <span class="font-medium text-gray-800">${studentsWithGrades}/${students.length}</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Rata-rata kelas:</span>
                                        <span class="font-medium text-gray-800">${averageScore || '-'}</span>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <span class="text-xs text-indigo-600 font-medium">Klik untuk melihat detail </span>
                                </div>
                            `;
                            
                            classList.appendChild(classCard);
                        }
                    }
                }
            });
            
            if (hasData) {
                document.getElementById('noPublicData').classList.add('hidden');
                document.getElementById('publicClassList').classList.remove('hidden');
            } else {
                document.getElementById('publicClassList').classList.add('hidden');
                document.getElementById('noPublicData').classList.remove('hidden');
            }
        }

        function showPublicGradeDetail(teacherName, subject, className, gradesData) {
            currentDetailData = { teacherName, subject, className, gradesData };
            
            const classData = studentsData[className];
            const students = Array.isArray(classData) ? classData : classData.students;
            
            const content = document.getElementById('gradeDetailContent');
            content.innerHTML = `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">${teacherName}</h4>
                    <p class="text-gray-600">${subject} - ${className}</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-2 py-3 text-center sticky-col">No</th>
                                <th class="border border-gray-300 px-3 py-3 text-left sticky-col-2">Nama</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 1</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 2</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 3</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-blue-100">Formatif 1</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 4</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 5</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 6</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-blue-100">Formatif 2</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 7</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 8</th>
                                <th class="border border-gray-300 px-2 py-3 text-center">TP 9</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-blue-100">Formatif 3</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-yellow-50">PSAT</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-yellow-50">PSAF</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-green-100">Rata-rata</th>
                                <th class="border border-gray-300 px-2 py-3 text-center bg-green-600 text-white">Nilai</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map((student, index) => {
                                const grades = gradesData[student] || {};
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="border border-gray-300 px-2 py-3 text-center sticky-col bg-white">${index + 1}</td>
                                        <td class="border border-gray-300 px-3 py-3 font-medium sticky-col-2 bg-white">${student}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp1 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp2 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp3 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-blue-100">${grades.formatif1 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp4 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp5 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp6 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-blue-100">${grades.formatif2 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp7 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp8 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center">${grades.tp9 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-blue-100">${grades.formatif3 || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-yellow-50">${grades.psat || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-yellow-50">${grades.psaf || '-'}</td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-green-100">
                                            <span class="font-medium text-green-800">${calculateAverage(grades) || '-'}</span>
                                        </td>
                                        <td class="border border-gray-300 px-2 py-3 text-center bg-green-600">
                                            <span class="font-bold text-white">${calculateFinalGrade(grades) || '-'}</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('gradeDetailModal').classList.remove('hidden');
            document.getElementById('gradeDetailModal').classList.add('flex');
        }

        function closeGradeDetailModal() {
            document.getElementById('gradeDetailModal').classList.add('hidden');
            document.getElementById('gradeDetailModal').classList.remove('flex');
            currentDetailData = null;
        }



        // Event listeners
        document.addEventListener('click', function(event) {
            const navBtn = document.getElementById('navMenuBtn');
            const dropdown = document.getElementById('navDropdown');
            const profileBtn = document.getElementById('profilePhotoBtn');
            const profileMenu = document.getElementById('profileMenu');
            
            // Close nav if clicking outside
            if (isNavOpen && navBtn && dropdown && 
                !navBtn.contains(event.target) && 
                !dropdown.contains(event.target)) {
                closeNav();
            }
            
            // Close profile menu if clicking outside
            if (isProfileMenuOpen && profileBtn && profileMenu && 
                !profileBtn.contains(event.target) && 
                !profileMenu.contains(event.target)) {
                closeProfileMenu();
            }
        });

        // CSS for navigation items and profile menu
        const style = document.createElement('style');
        style.textContent = `
            .nav-item {
                width: 100%;
                text-align: left;
                padding: 12px 16px;
                color: #374151;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .nav-item:hover {
                background-color: #f3f4f6;
                color: #4f46e5;
            }
            .profile-menu-item {
                width: 100%;
                text-align: left;
                padding: 12px 16px;
                color: #374151;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 12px;
                border: none;
                background: none;
            }
            .profile-menu-item:hover {
                background-color: #f3f4f6;
                color: #4f46e5;
            }
            .profile-menu-open {
                transform: scale(1) !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }
        `;
        document.head.appendChild(style);

        // Initialize
        function initializeApp() {
            // Load saved teachers data
            const savedTeachers = localStorage.getItem('teachersData');
            if (savedTeachers) {
                const parsedTeachers = JSON.parse(savedTeachers);
                Object.assign(teachers, parsedTeachers);
            }
            
            // Load saved students data
            const savedStudents = localStorage.getItem('studentsData');
            if (savedStudents) {
                const parsedStudents = JSON.parse(savedStudents);
                Object.assign(studentsData, parsedStudents);
            }
            
            showLoginScreen();
        }
        
        initializeApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966f38d085f44422',t:'MTc1MzgxOTQzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
